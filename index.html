<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUS TRACKING</title>
    <style>
        :root { --primary: #2a9d8f; --secondary: #023047; --accent: #ffd60a; --bg: #f0f2f5; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; }
        header { background: #fff; padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #liveClock { font-family: monospace; font-weight: bold; background: #eee; padding: 5px 10px; border-radius: 5px; }
        .btn-main { background: var(--primary); color: #fff; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .container { max-width: 1000px; margin: auto; padding: 20px; }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #ddd; box-sizing: border-box; }

        /* Dashboard Boxes */
        .upcoming { display: flex; gap: 15px; margin-bottom: 25px; }
        .up-box { flex: 1; background: #1b263b; color: #fff; border-radius: 20px; padding: 20px; text-align: center; }
        .count { font-size: 24px; font-weight: bold; color: var(--accent); }

        .admin-panel { background: #fff; border: 2px dashed var(--primary); padding: 25px; border-radius: 15px; margin-bottom: 25px; }

        /* BUS CARD UI */
        .card { background: #fff; padding: 22px; border-radius: 20px; margin: 15px 0; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
        .bus-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .status-badge { font-size: 11px; padding: 5px 12px; border-radius: 20px; font-weight: bold; }
        .status-on-route { background: #d1fae5; color: #065f46; }
        
        .progress-container { background: #f0f7ff; padding: 12px; border-radius: 12px; margin: 15px 0; border: 1px solid #e0efff; }
        .bar-bg { width: 100%; height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; margin: 8px 0; }
        .bar-fill { height: 100%; background: #2a9d8f; transition: width 1.5s ease-in-out; }
        
        .route-visual { display: flex; align-items: center; justify-content: space-between; margin: 20px 0; }
        .point b { font-size: 17px; display: block; }
        .line { flex: 1.5; height: 2px; background: #cbd5e0; margin: 0 15px; }

        .map-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; z-index: 9999; }
        #mapFrame { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>
    <header>
        <h3>üöç BUS TRACKING</h3>
        <div id="liveClock">00:00:00</div>
    </header>

    <div class="container">
        <div id="authWall">
            <div style="text-align:center; background:white; padding:40px; border-radius:20px; max-width:400px; margin:80px auto;">
                <h2>Admin Login</h2>
                <input type="email" id="uEmail" placeholder="email">
                <input type="password" id="uPass" placeholder="password">
                <button class="btn-main" style="width:100%; margin-top:15px;" id="loginBtn">Login</button>
            </div>
        </div>

        <div id="mainContent" class="hidden">
            <div class="upcoming">
                <div class="up-box">
                    <small>Next Departure</small><br>
                    <b id="depBusName">---</b>
                    <div class="count" id="depCounter">00:00:00</div>
                </div>
                <div class="up-box">
                    <small>Next Arrival</small><br>
                    <b id="arrBusName">---</b>
                    <div class="count" id="arrCounter">00:00:00</div>
                </div>
            </div>

            <div id="adminPortal" class="admin-panel hidden">
                <input id="travel" placeholder="Travels Name">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <select id="depCityAdmin"><option value="">Departure</option></select>
                    <input id="depTimeInput" placeholder="Time">
                    <select id="destCityAdmin"><option value="">Destination</option></select>
                    <input id="destTimeInput" placeholder="Time">
                </div>
                <div id="dynamicStops"></div>
                <button onclick="addStopField()" style="width:100%; margin:10px 0;">+ Add Route Stop</button>
                <input id="trackLink" placeholder="Tracking Link">
                <button onclick="saveBusToFirebase()" class="btn-main" style="width:100%">Save Bus Record</button>
            </div>

            <div id="busDisplayArea"></div>
        </div>
    </div>

    <div class="map-modal" id="mapModal">
        <button style="position:absolute; top:20px; right:20px; z-index:10" onclick="closeMap()">‚úï Close</button>
        <iframe id="mapFrame"></iframe>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0", projectId: "smart-bus-tracking-2ba21" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let busDataArr = [];
        let allCities = new Set();

        onAuthStateChanged(auth, user => {
            if (user) {
                mainContent.classList.remove('hidden'); authWall.classList.add('hidden');
                if (user.email === "admin@wintracking.com") adminPortal.classList.remove('hidden');
                rebuildUI();
            }
        });

        // TIME PARSER
        function parseTime(t) {
            if (!t || !t.includes(" ")) return null;
            let [time, mod] = t.split(" ");
            let [h, m] = time.split(":").map(Number);
            if (mod === "PM" && h !== 12) h += 12;
            let d = new Date(); d.setHours(h, m, 0);
            return d;
        }

        // UI SYNC
        window.rebuildUI = function() {
            const listArea = document.getElementById('busDisplayArea');
            listArea.innerHTML = "";

            busDataArr.forEach(b => {
                const card = document.createElement("div"); card.className = "card";
                const totalDist = 650;
                const progress = Math.min(((b.live_km || 0) / totalDist) * 100, 100);
                
                // Next Stop Logic
                let nextStop = b.destCity;
                if(b.route && b.live_km > 0) {
                    const upcoming = b.route.find(s => (s.km_marker || 0) > b.live_km);
                    if(upcoming) nextStop = upcoming.city;
                }

                card.innerHTML = `
                <div class="bus-header">
                    <b style="font-size:18px">üöç ${b.travel}</b>
                    <div class="status-badge status-on-route">${b.status || 'Stationary'}</div>
                </div>
                <div class="progress-container">
                    <div style="display:flex; justify-content:space-between; font-size:12px;">
                        <span>Progress: <b>${b.live_km || 0} KM</b></span>
                        <span style="color:#e63946">Remaining: <b>${(totalDist - (b.live_km || 0)).toFixed(1)} KM</b></span>
                    </div>
                    <div class="bar-bg"><div class="bar-fill" style="width: ${progress}%"></div></div>
                    <div style="display:flex; justify-content:space-between; font-size:11px; color:#555;">
                        <span>Next: <b>${nextStop}</b></span>
                        <span>Final Arrival: <b>${b.final_eta || '--'}</b></span>
                    </div>
                </div>
                <div class="route-visual">
                    <div class="point"><b>${b.depCity}</b><small>${b.depTime}</small></div>
                    <div class="line"></div>
                    <div class="point"><b>${b.destCity}</b><small>${b.destTime}</small></div>
                </div>
                <button class="btn-main" style="width:100%" onclick="openMap('${b.link}')">üìç Track Live Map</button>`;
                listArea.appendChild(card);
            });
            updateDashboard();
        };

        function updateDashboard() {
            const now = new Date();
            const deps = busDataArr.map(b => ({b, t: parseTime(b.depTime)})).filter(x => x.t > now).sort((a,b)=>a.t-b.t);
            if(deps.length > 0) {
                depBusName.innerText = deps[0].b.travel;
                const diff = Math.max(0, Math.floor((deps[0].t - now) / 1000));
                depCounter.innerText = `${Math.floor(diff/3600)}h ${Math.floor((diff%3600)/60)}m`;
            }
        }

        onSnapshot(collection(db, "buses"), snap => {
            busDataArr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            rebuildUI();
        });

        window.saveBusToFirebase = async () => {
            const link = document.getElementById('trackLink').value;
            const targetId = link.split('/').pop() || "NEW_BUS";
            const stops = [];
            document.querySelectorAll('.stop-entry').forEach(r => {
                const city = r.querySelector('.s-city').value;
                stops.push({ city, time: r.querySelector('.s-time').value, km_marker: parseInt(prompt(`KM for ${city}:`)) || 0 });
            });
            await setDoc(doc(db, "buses", targetId), {
                travel: travel.value, depCity: depCityAdmin.value, depTime: depTimeInput.value,
                destCity: destCityAdmin.value, destTime: destTimeInput.value, link: link,
                route: stops, live_km: 0, status: "Stationary"
            });
            location.reload();
        };

        window.addStopField = () => {
            const d = document.createElement("div"); d.className = "stop-entry"; d.style.display="flex"; d.style.gap="5px";
            d.innerHTML = `<input class="s-city" placeholder="City"><input class="s-time" placeholder="Time">`;
            document.getElementById('dynamicStops').appendChild(d);
        };

        window.openMap = (u) => { mapFrame.src = u; mapModal.style.display = 'block'; };
        window.closeMap = () => { mapModal.style.display = 'none'; mapFrame.src = ''; };
        loginBtn.onclick = () => signInWithEmailAndPassword(auth, uEmail.value, uPass.value);
        setInterval(() => { liveClock.innerText = new Date().toLocaleTimeString(); }, 1000);
    </script>
</body>
</html>

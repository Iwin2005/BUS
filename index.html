<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracking</title>

<style>
body{
    margin:0;
    font-family:Arial,sans-serif;
    background:linear-gradient(to right,#fff3b0,#ffd60a);
}
.container{
    max-width:900px;
    margin:auto;
    padding:15px;
}
h2{text-align:center;color:#3a2f00}

input,select,button{
    width:100%;
    padding:12px;
    margin:6px 0;
    border-radius:8px;
    border:none;
    font-size:16px;
}

button{font-weight:bold;cursor:pointer}
.sort-btn{background:#023047;color:#fff}
.track-btn{background:#2a9d8f;color:#fff}

.card{
    background:#fff8dc;
    padding:15px;
    border-radius:10px;
    margin:12px 0;
    box-shadow:0 0 8px rgba(0,0,0,.2)
}

.row{display:flex;gap:10px}
@media(max-width:600px){.row{flex-direction:column}}

.hidden{display:none}

/* NEXT DEPARTURE */
#nextDeparture{
    background:#fff;
    border-left:6px solid #2a9d8f;
    padding:12px;
    margin:12px 0;
    border-radius:8px
}

/* MAP MODAL */
.map-modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.85);
    display:none;
    z-index:9999;
    flex-direction:column
}
.map-header{
    background:#ffd60a;
    padding:10px;
    display:flex;
    justify-content:space-between;
    font-weight:bold
}
.map-header button{
    background:none;
    border:none;
    font-size:20px;
    cursor:pointer
}
#mapFrame{
    width:100%;
    height:calc(100% - 45px);
    border:none
}
</style>
</head>

<body>
<div class="container">

<h2>ğŸšŒ Smart Bus Tracking</h2>

<!-- NEXT DEPARTURE -->
<div id="nextDeparture"></div>

<!-- SEARCH -->
<input id="search" placeholder="Search city or travels">

<div class="row">
<select id="operatorSelect">
<option value="">All Operators</option>
</select>

<select id="travelMode">
<option value="departure">Departures</option>
<option value="arrival">Arrivals</option>
<option value="both">Both</option>
</select>
</div>

<button id="sortBtn" class="sort-btn">â° Earliest First</button>

<div id="busList"></div>

</div>

<!-- MAP MODAL -->
<div id="mapModal" class="map-modal">
    <div class="map-header">
        <span>ğŸ—º Live Bus Tracking</span>
        <button onclick="closeMap()">âœ–</button>
    </div>
    <iframe id="mapFrame"></iframe>
</div>

<script type="module">
/* ğŸ”¥ FIREBASE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",
 authDomain:"smart-bus-tracking-2ba21.firebaseapp.com",
 projectId:"smart-bus-tracking-2ba21",
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

/* STATE */
let data=[];
let sortOrder="asc";
let activeSearch="";
let activeOperator="";
let travelMode="departure";

/* ELEMENTS */
const busList=document.getElementById("busList");
const search=document.getElementById("search");
const operatorSelect=document.getElementById("operatorSelect");
const travelModeSelect=document.getElementById("travelMode");
const sortBtn=document.getElementById("sortBtn");

/* EVENTS */
search.oninput=e=>{
    activeSearch=e.target.value.toLowerCase().trim();
    render();
};
operatorSelect.onchange=e=>{
    activeOperator=e.target.value;
    render();
};
travelModeSelect.onchange=e=>{
    travelMode=e.target.value;
    render();
};
sortBtn.onclick=()=>{
    sortOrder=sortOrder==="asc"?"desc":"asc";
    sortBtn.innerText=sortOrder==="asc"?"â° Earliest First":"â° Latest First";
    render();
};

/* HELPERS */
function toMin(t){
 let[p,m]=t.split(" ");
 let[h,mm]=p.split(":").map(Number);
 if(m==="PM"&&h!==12)h+=12;
 if(m==="AM"&&h===12)h=0;
 return h*60+mm;
}

/* MAP */
window.openMap=url=>{
 document.getElementById("mapFrame").src=url;
 document.getElementById("mapModal").style.display="flex";
 document.body.style.overflow="hidden";
};
window.closeMap=()=>{
 document.getElementById("mapFrame").src="";
 document.getElementById("mapModal").style.display="none";
 document.body.style.overflow="auto";
};

/* RENDER */
function render(){
 busList.innerHTML="";
 let shown=0;

 let filtered=data.filter(b=>{
   if(activeOperator && b.travel!==activeOperator) return false;
   return true;
 });

 filtered.sort((a,b)=>{
   let t1=toMin(a.route[0].time);
   let t2=toMin(b.route[0].time);
   return sortOrder==="asc"?t1-t2:t2-t1;
 });

 filtered.forEach(bus=>{
   const first=bus.route[0];
   const last=bus.route.at(-1);

   let cityMatch=bus.route.find(r=>r.city.toLowerCase().includes(activeSearch));
   let operatorMatch=bus.travel.toLowerCase().includes(activeSearch);

   let show=false;
   let label="";

   if(!activeSearch){
     show=true;
     label="ğŸŸ¢ Departs from "+first.city;
   }
   else if(cityMatch){
     if(travelMode==="departure" && cityMatch.city===first.city){
        show=true; label="ğŸŸ¢ Departs from "+first.city;
     }
     else if(travelMode==="arrival" && cityMatch.city===last.city){
        show=true; label="ğŸ”µ Arrives at "+last.city;
     }
     else if(travelMode==="both"){
        show=true;
        label = cityMatch.city===first.city?"ğŸŸ¢ Departs from "+first.city
             : cityMatch.city===last.city?"ğŸ”µ Arrives at "+last.city
             : "â¡ Via "+cityMatch.city;
     }
   }
   else if(operatorMatch){
     show=true; label="ğŸšŒ Operator match";
   }

   if(!show) return;

   shown++;

   const card=document.createElement("div");
   card.className="card";
   card.innerHTML=`
     <h3>ğŸšŒ ${bus.travel}</h3>
     <b>${first.city} â†’ ${last.city}</b><br><br>
     ${bus.route.map((r,i)=>`
        ${i===0?"ğŸ“":i===bus.route.length-1?"ğŸ":"â¡"}
        ${r.city} ${r.time}
     `).join("<br>")}
     <br><br><b>${label}</b><br><br>
     <button class="track-btn" onclick="openMap('${bus.link}')">Track</button>
   `;
   busList.appendChild(card);
 });

 /* AUTO FIX EMPTY RESULT */
 if(shown===0 && activeSearch && travelMode!=="both"){
   travelMode="both";
   travelModeSelect.value="both";
   render();
 }
}

/* OPERATORS */
function renderOperators(){
 const ops=[...new Set(data.map(b=>b.travel))];
 operatorSelect.innerHTML='<option value="">All Operators</option>';
 ops.forEach(o=>{
   const op=document.createElement("option");
   op.value=o; op.textContent=o;
   operatorSelect.appendChild(op);
 });
}

/* NEXT DEPARTURE */
function renderNext(){
 const box=document.getElementById("nextDeparture");
 const now=Date.now();

 let future=data.map(b=>{
   let t=toMin(b.route[0].time);
   let d=new Date(); d.setHours(Math.floor(t/60),t%60,0,0);
   return {bus:b,time:d.getTime()};
 }).filter(x=>x.time>now);

 if(!future.length){
   box.innerHTML="<b>ğŸš¨ NEXT DEPARTURE</b><br>No upcoming buses";
   return;
 }

 let soon=Math.min(...future.map(f=>f.time));
 let list=future.filter(f=>f.time===soon);

 function tick(){
   let diff=soon-Date.now();
   if(diff<=0){renderNext();return;}
   let s=Math.floor(diff/1000);
   box.innerHTML=`
     <b>ğŸš¨ NEXT DEPARTURE</b><br><br>
     ${list.map(o=>`
        ğŸšŒ ${o.bus.travel}<br>
        ğŸ“ ${o.bus.route[0].city} â†’ ${o.bus.route.at(-1).city}<br>
        â° ${o.bus.route[0].time}<br><br>
     `).join("")}
     â³ Departs in ${Math.floor(s/3600)}h ${Math.floor(s%3600/60)}m ${s%60}s
   `;
 }
 tick();
 setInterval(tick,1000);
}

/* FIRESTORE */
onSnapshot(collection(db,"buses"),snap=>{
 data=[];
 snap.forEach(d=>data.push(d.data()));
 renderOperators();
 renderNext();
 render();
});
</script>
</body>
</html>
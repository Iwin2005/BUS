<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracking Pro</title>

<style>
:root {
    --primary: #2a9d8f;
    --secondary: #023047;
    --accent: #ffd60a;
    --bg: #f0f2f5;
    --card-bg: #ffffff;
}

body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: #333;
}

.container { max-width: 800px; margin: auto; padding: 20px; }

h2 { text-align: center; color: var(--secondary); margin-bottom: 25px; }

/* INPUTS & BUTTONS */
input, select, button {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border-radius: 10px;
    border: 1px solid #ddd;
    font-size: 16px;
    box-sizing: border-box;
}

button { 
    cursor: pointer; 
    font-weight: bold; 
    transition: all 0.2s; 
    border: none;
}

button:active { transform: scale(0.98); }

.row { display: flex; gap: 12px; }
@media(max-width: 700px) { .row { flex-direction: column; } }

/* CARDS */
.card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    margin: 15px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border-left: 5px solid var(--primary);
}

.track-btn { background: var(--primary); color: #fff; margin-top: 15px; }
.track-btn:hover { background: #21867a; }

.sort-btn { background: var(--secondary); color: #fff; }

.hidden { display: none; }

/* UPCOMING DASHBOARD */
.upcoming { display: flex; gap: 12px; margin-bottom: 20px; }
.up-box {
    flex: 1;
    background: #1b263b;
    color: #fff;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.up-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #a2a2a2; }
.up-date { font-size: 14px; margin: 8px 0; color: var(--accent); }
.count { font-size: 20px; font-weight: bold; font-family: monospace; }

/* TIMELINE DESIGN */
.timeline-item {
    display: flex;
    align-items: center;
    position: relative;
    padding-bottom: 15px;
}
.timeline-item:last-child { padding-bottom: 0; }
.timeline-item::before {
    content: '';
    position: absolute;
    left: 6px;
    top: 15px;
    width: 2px;
    height: 100%;
    background: #e0e0e0;
}
.timeline-item:last-child::before { display: none; }

.dot {
    width: 14px;
    height: 14px;
    background: var(--primary);
    border-radius: 50%;
    margin-right: 15px;
    z-index: 1;
    border: 3px solid #fff;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
}

/* MAP MODAL */
.map-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    z-index: 9999;
}
.map-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: var(--accent);
    border: none;
    font-size: 24px;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    cursor: pointer;
}
#mapFrame { width: 100%; height: 100%; border: none; }

/* SEARCH HIGHLIGHT */
#search {
    border: 2px solid var(--primary);
    background: #fff;
}
</style>
</head>

<body>
<div class="container">

<h2>üöå Smart Bus Tracking</h2>

<div class="upcoming">
  <div class="up-box" id="upDep">Wait...</div>
  <div class="up-box" id="upArr">Wait...</div>
</div>

<input id="search" placeholder="üîç Search city, travels or operator...">

<button id="sortBtn" class="sort-btn">‚è∞ Sort: Earliest First</button>

<div id="busList"></div>

<hr style="margin: 40px 0; border: 0; border-top: 1px solid #ccc;">

<h3>üîê Admin Access</h3>
<div id="loginBox">
  <input id="email" placeholder="Admin Email">
  <input id="pass" type="password" placeholder="Password">
  <button id="loginBtn" style="background:#023047; color:white;">Login</button>
</div>

<div id="adminPanel" class="hidden card" style="border-left-color: #e76f51;">
  <h3>üõ† Admin Panel</h3>
  <input id="travel" placeholder="Travels Name">
  
  <h4>Route Management</h4>
  <div id="routes">
    <div class="row">
      <input class="city" placeholder="City Name">
      <input class="time" placeholder="06:05 PM">
    </div>
  </div>

  <button onclick="addRoute()" style="background:#eee; color:#333;">‚ûï Add Stop</button>
  <input id="link" placeholder="Google Maps Tracking Link">

  <button onclick="saveBus()" style="background:#2a9d8f; color:white;">üíæ Save Bus to Database</button>
  <button onclick="logout()" style="background:#e63946; color:white; margin-top:20px;">Logout</button>
</div>

</div>

<div class="map-modal" id="mapModal">
  <button class="map-close" onclick="closeMap()">‚úï</button>
  <iframe id="mapFrame"></iframe>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* FIREBASE CONFIG */
const app = initializeApp({
  apiKey: "AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",
  authDomain: "smart-bus-tracking-2ba21.firebaseapp.com",
  projectId: "smart-bus-tracking-2ba21"
});
const db = getFirestore(app);
const auth = getAuth(app);

/* STATE */
let data = [];
let sortAsc = true;

/* TIME HELPERS */
function toMin(t) {
    if(!t) return 0;
    let [p, m] = t.split(" ");
    let [h, mm] = p.split(":").map(Number);
    if (m === "PM" && h !== 12) h += 12;
    if (m === "AM" && h === 12) h = 0;
    return h * 60 + mm;
}

function nextDate(time) {
    let d = new Date();
    const m = toMin(time);
    d.setHours(Math.floor(m / 60), m % 60, 0, 0);
    if (d < Date.now()) d.setDate(d.getDate() + 1);
    return d;
}

function fmt(d) {
    return d.toLocaleTimeString("en-GB", { hour: '2-digit', minute: '2-digit' });
}

/* SEARCH & FILTER LOGIC */
document.getElementById('search').addEventListener('input', renderList);
document.getElementById('sortBtn').onclick = () => {
    sortAsc = !sortAsc;
    document.getElementById('sortBtn').innerText = sortAsc ? "‚è∞ Sort: Earliest First" : "‚è∞ Sort: Latest First";
    renderList();
};

/* MAP FUNCTIONS */
window.openMap = url => {
    document.getElementById('mapFrame').src = url;
    document.getElementById('mapModal').style.display = "block";
}
window.closeMap = () => {
    document.getElementById('mapFrame').src = "";
    document.getElementById('mapModal').style.display = "none";
}

/* LIST RENDERING */
function renderList() {
    const busList = document.getElementById('busList');
    const searchTerm = document.getElementById('search').value.toLowerCase();
    busList.innerHTML = "";
    
    let list = [...data].filter(b => 
        b.travel.toLowerCase().includes(searchTerm) || 
        b.route.some(r => r.city.toLowerCase().includes(searchTerm))
    );

    list.sort((a, b) => {
        const timeA = toMin(a.route[0].time);
        const timeB = toMin(b.route[0].time);
        return sortAsc ? timeA - timeB : timeB - timeA;
    });

    list.forEach(b => {
        const c = document.createElement("div");
        c.className = "card";
        
        const routeHtml = b.route.map((r, i) => `
            <div class="timeline-item">
                <div class="dot" style="background: ${i === 0 ? '#2a9d8f' : (i === b.route.length-1 ? '#e76f51' : '#023047')}"></div>
                <div style="flex:1"><b>${r.city}</b></div>
                <div style="color:#666; font-size:14px">${r.time}</div>
            </div>
        `).join("");

        c.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                <h3 style="margin:0; color:#023047">üöå ${b.travel}</h3>
                <span style="font-size:12px; background:#e9f5f3; color:#2a9d8f; padding:4px 8px; border-radius:5px; font-weight:bold">LIVE</span>
            </div>
            <div class="route-container">${routeHtml}</div>
            <button class="track-btn" onclick="openMap('${b.link}')">üìç Track Live Location</button>
        `;
        busList.appendChild(c);
    });
}

/* UPCOMING DASHBOARD LOGIC */
function renderUpcoming() {
    if (!data.length) return;
    
    function tick() {
        let deps = data.map(b => ({ t: nextDate(b.route[0].time) })).sort((a,b) => a.t - b.t);
        let arrs = data.map(b => ({ t: nextDate(b.route.at(-1).time) })).sort((a,b) => a.t - b.t);

        const dMin = deps[0].t;
        const aMin = arrs[0].t;

        const d = Math.max(0, Math.floor((dMin - Date.now()) / 1000));
        const a = Math.max(0, Math.floor((aMin - Date.now()) / 1000));

        document.getElementById('upDep').innerHTML = `
            <div class="up-title">Next Departure</div>
            <div class="up-date">at ${fmt(dMin)}</div>
            <div class="count">${Math.floor(d/3600)}h ${Math.floor((d%3600)/60)}m ${d%60}s</div>
        `;
        document.getElementById('upArr').innerHTML = `
            <div class="up-title">Next Arrival</div>
            <div class="up-date">at ${fmt(aMin)}</div>
            <div class="count">${Math.floor(a/3600)}h ${Math.floor((a%3600)/60)}m ${a%60}s</div>
        `;
    }
    tick();
    setInterval(tick, 1000);
}

/* ADMIN LOGIC */
document.getElementById('loginBtn').onclick = () => {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;
    signInWithEmailAndPassword(auth, email, pass).catch(e => alert(e.message));
};

window.logout = () => signOut(auth);

onAuthStateChanged(auth, u => {
    document.getElementById('loginBox').classList.toggle("hidden", !!u);
    document.getElementById('adminPanel').classList.toggle("hidden", !u);
});

window.addRoute = () => {
    const d = document.createElement("div");
    d.className = "row";
    d.innerHTML = `<input class="city" placeholder="City Name"><input class="time" placeholder="00:00 AM/PM">`;
    document.getElementById('routes').appendChild(d);
}

window.saveBus = async () => {
    let route = [];
    const cities = document.querySelectorAll(".city");
    const times = document.querySelectorAll(".time");
    
    cities.forEach((c, i) => {
        if (c.value && times[i].value) route.push({ city: c.value, time: times[i].value });
    });

    if (route.length < 2) return alert("Please add at least 2 stops");
    
    try {
        await addDoc(collection(db, "buses"), {
            travel: document.getElementById('travel').value,
            route,
            link: document.getElementById('link').value
        });
        alert("Bus Added Successfully!");
        location.reload(); 
    } catch(e) { alert(e.message); }
};

/* DATA INITIALIZATION */
onSnapshot(collection(db, "buses"), snap => {
    data = [];
    snap.forEach(doc => data.push(doc.data()));
    renderUpcoming();
    renderList();
});
</script>
</body>
</html>

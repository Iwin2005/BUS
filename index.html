<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BUS TRACKING</title>
<style>
:root { --primary:#2a9d8f; --secondary:#023047; --accent:#ffd60a; --bg:#f0f2f5; }
body { margin:0; font-family:'Segoe UI',sans-serif; background:var(--bg); }
.hidden{display:none!important}
.btn-main{background:var(--primary);color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer}
.container{max-width:1000px;margin:auto;padding:20px}
</style>
</head>

<body>

<header>
<h3>üöç BUS TRACKING</h3>
<div id="loggedInLinks" class="hidden">
<span id="userEmailDisplay"></span>
<button id="logoutBtn" class="btn-main">Logout</button>
</div>
</header>

<div class="container">

<div id="authWall">
<input id="uEmail" placeholder="email">
<input id="uPass" type="password" placeholder="password">
<button id="loginBtn" class="btn-main">Login</button>
</div>

<div id="mainContent" class="hidden">

<div id="adminPortal" class="hidden">
<h3>üõ† Admin Portal</h3>

<input id="travel" placeholder="Travels Name">

<select id="depCityAdmin"></select>
<input id="depTimeInput" placeholder="Time">

<select id="destCityAdmin"></select>
<input id="destTimeInput" placeholder="Time">

<button onclick="addNewCity()" class="btn-main">‚ûï Add New City Name</button>

<div id="dynamicStops"></div>

<input id="trackLink" placeholder="Tracking Link">
<input type="hidden" id="editingBusId">

<button onclick="saveBusToFirebase()" class="btn-main">Save</button>
</div>

<select id="fromCity"></select>
<select id="toCity"></select>

<div id="busDisplayArea"></div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
apiKey:"AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",
authDomain:"smart-bus-tracking-2ba21.firebaseapp.com",
projectId:"smart-bus-tracking-2ba21"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const ADMIN_EMAIL="admin@wintracking.com";
let busDataArr=[];
let allCities=new Set();

/* üîß FIX START */
function refreshCityDropdowns(){
const sorted=[...allCities].sort();
const opts=sorted.map(c=>`<option value="${c}">${c}</option>`).join('');
depCityAdmin.innerHTML=`<option value="">Select Departure City</option>`+opts;
destCityAdmin.innerHTML=`<option value="">Select Destination City</option>`+opts;
fromCity.innerHTML=`<option value="">Select Boarding City</option>`+opts;
toCity.innerHTML=`<option value="">Select Destination</option>`+opts;
}

window.addNewCity=()=>{
const c=prompt("City Name:");
if(!c) return;
allCities.add(c.trim());
refreshCityDropdowns();
};
/* üîß FIX END */

onAuthStateChanged(auth,user=>{
if(user){
mainContent.classList.remove('hidden');
authWall.classList.add('hidden');
loggedInLinks.classList.remove('hidden');
userEmailDisplay.innerText=user.email;
user.email===ADMIN_EMAIL ? adminPortal.classList.remove('hidden') : adminPortal.classList.add('hidden');
}else{
mainContent.classList.add('hidden');
authWall.classList.remove('hidden');
}
});

onSnapshot(collection(db,"buses"),snap=>{
busDataArr=snap.docs.map(d=>d.data());
allCities.clear();
busDataArr.forEach(b=>{
allCities.add(b.depCity);
allCities.add(b.destCity);
b.route?.forEach(r=>allCities.add(r.city));
});
refreshCityDropdowns();
});

loginBtn.onclick=()=>signInWithEmailAndPassword(auth,uEmail.value,uPass.value);
logoutBtn.onclick=()=>signOut(auth);

</script>
</body>
</html>
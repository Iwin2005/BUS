<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracking</title>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(to right,#fff3b0,#ffd60a);
}
.container{max-width:1100px;margin:auto;padding:15px}
h2{text-align:center;color:#3a2f00}

input,select,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:8px;
  border:none;
  font-size:16px;
}
button{cursor:pointer;font-weight:bold}

.row{display:flex;gap:12px}
@media(max-width:700px){.row{flex-direction:column}}

.card{
  background:#fff8dc;
  padding:15px;
  border-radius:10px;
  margin:12px 0;
  box-shadow:0 0 8px rgba(0,0,0,.2)
}

.track-btn{background:#2a9d8f;color:#fff}
.sort-btn{background:#023047;color:#fff}

.hidden{display:none}

/* UPCOMING */
.upcoming{
  display:flex;
  gap:12px;
  margin-bottom:10px
}
.up-box{
  flex:1;
  background:#1f1f1f;
  color:#fff;
  border-radius:12px;
  padding:15px
}
.up-title{text-align:center;font-size:18px;font-weight:bold}
.up-date{text-align:center;font-size:14px;margin:6px 0}
.count{margin-top:6px;font-weight:bold}

/* MAP */
.map-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  z-index:9999;
}
.map-close{
  position:absolute;
  top:10px;
  right:10px;
  background:#ffd60a;
  border:none;
  font-size:22px;
  width:40px;
  height:40px;
  border-radius:50%;
}
#mapFrame{width:100%;height:100%;border:none}
</style>
</head>

<body>
<div class="container">

<h2>üöå Smart Bus Tracking</h2>

<!-- UPCOMING -->
<div class="upcoming">
  <div class="up-box" id="upDep"></div>
  <div class="up-box" id="upArr"></div>
</div>

<input id="search" placeholder="Search city or travels">

<div class="row">
  <select id="operator"><option value="">All Operators</option></select>
</div>

<button id="sortBtn" class="sort-btn">‚è∞ Earliest First</button>

<div id="busList"></div>

<hr>

<h3>üîê Admin Login</h3>
<div id="loginBox">
  <input id="email" placeholder="Admin Email">
  <input id="pass" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
</div>

<div id="adminPanel" class="hidden card">
  <h3>‚úÖ Admin Panel</h3>

  <input id="travel" placeholder="Travels Name">

  <h4>Route</h4>
  <div id="routes">
    <div class="row">
      <input class="city" placeholder="City">
      <input class="time" placeholder="06:05 PM">
    </div>
  </div>

  <button onclick="addRoute()">‚ûï Add Stop</button>

  <input id="link" placeholder="Tracking Link">

  <button onclick="saveBus()">üíæ Save Bus</button>
  <button onclick="logout()">Logout</button>
</div>

</div>

<!-- MAP -->
<div class="map-modal" id="mapModal">
  <button class="map-close" onclick="closeMap()">‚úñ</button>
  <iframe id="mapFrame"></iframe>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",
  authDomain:"smart-bus-tracking-2ba21.firebaseapp.com",
  projectId:"smart-bus-tracking-2ba21"
});
const db=getFirestore(app);
const auth=getAuth(app);

/* STATE */
let data=[],sortAsc=true;

/* HELPERS */
function toMin(t){
 let[p,m]=t.split(" ");
 let[h,mm]=p.split(":").map(Number);
 if(m==="PM"&&h!==12)h+=12;
 if(m==="AM"&&h===12)h=0;
 return h*60+mm;
}
function nextDate(time){
 let d=new Date();
 const m=toMin(time);
 d.setHours(Math.floor(m/60),m%60,0,0);
 if(d<Date.now()) d.setDate(d.getDate()+1);
 return d;
}
function fmt(d){
 return d.toLocaleDateString("en-GB")+" "+d.toLocaleTimeString("en-GB");
}

/* MAP */
window.openMap=url=>{
 mapFrame.src=url;
 mapModal.style.display="block";
}
window.closeMap=()=>{
 mapFrame.src="";
 mapModal.style.display="none";
}

/* UPCOMING */
function renderUpcoming(){
 if(!data.length){upDep.innerHTML="";upArr.innerHTML="";return}

 let deps=[],arrs=[];
 data.forEach(b=>{
  deps.push({bus:b,time:nextDate(b.route[0].time)});
  arrs.push({bus:b,time:nextDate(b.route.at(-1).time)});
 });

 const dMin=Math.min(...deps.map(x=>x.time));
 const aMin=Math.min(...arrs.map(x=>x.time));

 function tick(){
  const d=Math.max(0,Math.floor((dMin-Date.now())/1000));
  const a=Math.max(0,Math.floor((aMin-Date.now())/1000));

  upDep.innerHTML=`
   <div class="up-title">üö® UPCOMING DEPARTURE</div>
   <div class="up-date">üìÖ ${fmt(new Date(dMin))}</div>
   ‚è≥ ${Math.floor(d/3600)}h ${Math.floor((d%3600)/60)}m ${d%60}s
  `;
  upArr.innerHTML=`
   <div class="up-title">üöè UPCOMING ARRIVAL</div>
   <div class="up-date">üìÖ ${fmt(new Date(aMin))}</div>
   ‚è≥ ${Math.floor(a/3600)}h ${Math.floor((a%3600)/60)}m ${a%60}s
  `;
 }
 tick();
 setInterval(tick,1000);
}

/* LIST */
function renderList(){
 busList.innerHTML="";
 let list=[...data];
 if(!sortAsc) list.reverse();

 list.forEach(b=>{
  const c=document.createElement("div");
  c.className="card";
  c.innerHTML=`
   <h3>üöå ${b.travel}</h3>
   ${b.route.map(r=>`‚û° ${r.city} ${r.time}`).join("<br>")}
   <br><br>
   <button class="track-btn" onclick="openMap('${b.link}')">Track</button>
  `;
  busList.appendChild(c);
 });
}

/* ADMIN */
loginBtn.onclick=()=>signInWithEmailAndPassword(auth,email.value,pass.value)
 .catch(e=>alert(e.message));
window.logout=()=>signOut(auth);

onAuthStateChanged(auth,u=>{
 loginBox.classList.toggle("hidden",!!u);
 adminPanel.classList.toggle("hidden",!u);
});

/* ADD BUS */
window.addRoute=()=>{
 const d=document.createElement("div");
 d.className="row";
 d.innerHTML=`<input class="city"><input class="time">`;
 routes.appendChild(d);
}
window.saveBus=async()=>{
 let route=[];
 document.querySelectorAll(".city").forEach((c,i)=>{
  const t=document.querySelectorAll(".time")[i];
  if(c.value&&t.value) route.push({city:c.value,time:t.value});
 });
 if(route.length<2)return alert("Add at least 2 stops");
 await addDoc(collection(db,"buses"),{
  travel:travel.value,
  route,
  link:link.value
 });
 alert("Bus Added");
};

/* DATA */
onSnapshot(collection(db,"buses"),snap=>{
 data=[];
 snap.forEach(d=>data.push(d.data()));
 renderUpcoming();
 renderList();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracking</title>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(to right,#fff3b0,#ffd60a);
}
.container{max-width:900px;margin:auto;padding:15px}
h2{text-align:center;color:#3a2f00}

input,select,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:8px;
  border:none;
  font-size:16px;
}
button{cursor:pointer;font-weight:bold}

.track-btn{background:#2a9d8f;color:#fff}
.sort-btn{background:#023047;color:#fff}

.card{
  background:#fff8dc;
  padding:15px;
  border-radius:10px;
  margin:12px 0;
  box-shadow:0 0 8px rgba(0,0,0,.2)
}

.row{display:flex;gap:10px}
.row input,.row select{flex:1}
@media(max-width:600px){.row{flex-direction:column}}

.hidden{display:none}

/* NEXT DEPARTURE */
#nextDeparture{
  background:#fff;
  border-left:6px solid #2a9d8f;
  padding:12px;
  margin:12px 0;
  border-radius:8px
}

/* MAP */
.map-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  z-index:9999;
}
.map-close{
  position:absolute;
  top:10px;
  right:10px;
  background:#ffd60a;
  border:none;
  font-size:22px;
  width:40px;
  height:40px;
  border-radius:50%;
}
#mapFrame{width:100%;height:100%;border:none}

/* ADMIN */
#adminPanel{
  background:#fff;
  padding:15px;
  border-radius:10px;
  margin-top:20px
}
.via-row button{background:#d00000;color:#fff}
</style>
</head>

<body>
<div class="container">

<h2>üöå Smart Bus Tracking</h2>

<!-- NEXT DEPARTURE -->
<div id="nextDeparture"></div>

<input id="search" placeholder="Search city or travels">

<div class="row">
<select id="operatorSelect">
<option value="">All Operators</option>
</select>

<select id="journeyFilter">
<option value="both">Boarding & Dropping</option>
<option value="boarding">Boarding</option>
<option value="dropping">Dropping</option>
</select>
</div>

<button id="sortBtn" class="sort-btn">‚è∞ Earliest First</button>

<div id="busList"></div>

<hr>

<h3>üîê Admin Login</h3>
<div id="loginBox">
<input id="adminEmail" placeholder="Admin Email">
<input id="adminPass" type="password" placeholder="Password">
<button id="loginBtn">Login</button>
</div>

<div id="adminPanel" class="hidden">
<h3>Admin Panel</h3>

<input id="travel" placeholder="Travels Name">

<div class="row">
<input id="fromCity" placeholder="From City">
<input id="fromTime" placeholder="05:30 PM">
</div>

<h4>Via Stops</h4>
<div id="viaContainer"></div>
<button type="button" onclick="addVia()">‚ûï Add Via Stop</button>

<div class="row">
<input id="toCity" placeholder="To City">
<input id="toTime" placeholder="07:00 AM">
</div>

<input id="link" placeholder="Tracking Link">

<button id="saveBtn">Save</button>
<button onclick="logout()">Logout</button>
</div>
</div>

<!-- MAP -->
<div id="mapModal" class="map-modal">
<button class="map-close" onclick="closeMap()">‚úñ</button>
<iframe id="mapFrame"></iframe>
</div>

<script type="module">
/* FIREBASE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const app = initializeApp({
 apiKey:"AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",
 authDomain:"smart-bus-tracking-2ba21.firebaseapp.com",
 projectId:"smart-bus-tracking-2ba21"
});
const db = getFirestore(app);
const auth = getAuth(app);

/* STATE */
let data=[];
let searchTxt="";
let operator="";
let journey="both";
let sortOrder="asc";
let countdownTimer=null;

/* EVENTS */
search.oninput=e=>{searchTxt=e.target.value.toLowerCase();render()};
operatorSelect.onchange=e=>{operator=e.target.value;render()};
journeyFilter.onchange=e=>{journey=e.target.value;render()};
sortBtn.onclick=()=>{
 sortOrder=sortOrder==="asc"?"desc":"asc";
 sortBtn.innerText=sortOrder==="asc"?"‚è∞ Earliest First":"‚è∞ Latest First";
 render();
};

/* TIME */
function toMin(t){
 let[p,m]=t.split(" ");
 let[h,mm]=p.split(":").map(Number);
 if(m==="PM"&&h!==12)h+=12;
 if(m==="AM"&&h===12)h=0;
 return h*60+mm;
}

/* MAP */
window.openMap=url=>{
 mapFrame.src=url;
 mapModal.style.display="block";
};
window.closeMap=()=>{
 mapFrame.src="";
 mapModal.style.display="none";
};

/* VIA */
window.addVia=()=>{
 const div=document.createElement("div");
 div.className="row via-row";
 div.innerHTML=`
   <input class="viaCity" placeholder="Via City">
   <input class="viaTime" placeholder="Time">
   <select class="viaType">
     <option value="via">Via</option>
     <option value="boarding">Boarding</option>
     <option value="dropping">Dropping</option>
   </select>
   <button onclick="this.parentElement.remove()">‚úñ</button>
 `;
 viaContainer.appendChild(div);
};

/* SAVE */
saveBtn.onclick=async()=>{
 let route=[];

 route.push({city:fromCity.value,time:fromTime.value,type:"boarding"});

 document.querySelectorAll(".via-row").forEach(r=>{
  const c=r.querySelector(".viaCity").value;
  const t=r.querySelector(".viaTime").value;
  const ty=r.querySelector(".viaType").value;
  if(c&&t) route.push({city:c,time:t,type:ty});
 });

 route.push({city:toCity.value,time:toTime.value,type:"dropping"});

 await addDoc(collection(db,"buses"),{
  travel:travel.value,
  route,
  link:link.value
 });

 alert("Bus Saved ‚úÖ");
 viaContainer.innerHTML="";
};

/* NEXT DEPARTURE (FIXED) */
function renderNextDeparture(){
 if(countdownTimer) clearInterval(countdownTimer);

 const now=Date.now();
 let upcoming=[];

 data.forEach(bus=>{
   const dep=bus.route.find(r=>r.type==="boarding") || bus.route[0];
   const mins=toMin(dep.time);
   const d=new Date();
   d.setHours(Math.floor(mins/60),mins%60,0,0);
   if(d.getTime()>now) upcoming.push({bus,dep,time:d.getTime()});
 });

 if(!upcoming.length){
   nextDeparture.innerHTML="<b>üö® NEXT DEPARTURE</b><br>No upcoming buses";
   return;
 }

 const soon=Math.min(...upcoming.map(u=>u.time));
 const list=upcoming.filter(u=>u.time===soon);

 function tick(){
  const diff=soon-Date.now();
  if(diff<=0){renderNextDeparture();return;}
  const s=Math.floor(diff/1000);
  nextDeparture.innerHTML=`
    <b>üö® NEXT DEPARTURE</b><br><br>
    ${list.map(o=>`
      üöå ${o.bus.travel}<br>
      üìç ${o.dep.city} ‚Üí ${o.bus.route.at(-1).city}<br>
      ‚è∞ ${o.dep.time}<br><br>
    `).join("")}
    ‚è≥ Departs in ${Math.floor(s/3600)}h ${Math.floor(s%3600/60)}m ${s%60}s
  `;
 }
 tick();
 countdownTimer=setInterval(tick,1000);
}

/* RENDER */
function render(){
 busList.innerHTML="";
 let shown=0;

 let list=[...data];
 if(operator) list=list.filter(b=>b.travel===operator);

 list.forEach(bus=>{
  const matchCity=bus.route.find(r=>r.city.toLowerCase().includes(searchTxt));
  const matchOp=bus.travel.toLowerCase().includes(searchTxt);

  if(searchTxt && !matchCity && !matchOp) return;
  if(matchCity){
    if(journey==="boarding" && matchCity.type!=="boarding") return;
    if(journey==="dropping" && matchCity.type!=="dropping") return;
  }

  shown++;

  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`
    <h3>üöå ${bus.travel}</h3>
    ${bus.route.map(r=>`
      ${r.type==="boarding"?"üü¢":r.type==="dropping"?"üîµ":"‚û°"}
      ${r.city} ${r.time}
    `).join("<br>")}
    <br><br>
    <button class="track-btn" onclick="openMap('${bus.link}')">Track</button>
  `;
  busList.appendChild(card);
 });

 if(!shown){
  busList.innerHTML="<div class='card'>‚ùå No buses found</div>";
 }
}

/* OPERATORS */
function renderOperators(){
 operatorSelect.innerHTML='<option value="">All Operators</option>';
 [...new Set(data.map(b=>b.travel))].forEach(o=>{
  const op=document.createElement("option");
  op.value=o;op.textContent=o;
  operatorSelect.appendChild(op);
 });
}

/* AUTH */
loginBtn.onclick=()=>{
 signInWithEmailAndPassword(auth,adminEmail.value,adminPass.value)
 .catch(e=>alert(e.message));
};
window.logout=()=>signOut(auth);

onAuthStateChanged(auth,user=>{
 loginBox.classList.toggle("hidden",!!user);
 adminPanel.classList.toggle("hidden",!user);
});

/* FIRESTORE */
onSnapshot(collection(db,"buses"),snap=>{
 data=[];
 snap.forEach(d=>data.push(d.data()));
 renderOperators();
 render();
 renderNextDeparture();
});
</script>
</body>
</html>

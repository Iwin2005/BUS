<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracking Pro</title>

<style>
:root {
    --primary: #2a9d8f;
    --secondary: #023047;
    --accent: #ffd60a;
    --bg: #f0f2f5;
    --card-bg: #ffffff;
}

body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: #333;
}

.container { max-width: 900px; margin: auto; padding: 20px; }
h2 { text-align: center; color: var(--secondary); margin-bottom: 25px; }

/* INPUTS & BUTTONS */
input, select, button {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border-radius: 10px;
    border: 1px solid #ddd;
    font-size: 15px;
    box-sizing: border-box;
}

button { cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
button:active { transform: scale(0.98); }

.row { display: flex; gap: 10px; align-items: flex-end; }
@media(max-width: 700px) { .row { flex-direction: column; } }

/* CARDS */
.card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    margin: 15px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border-left: 5px solid var(--primary);
}

.track-btn { background: var(--primary); color: #fff; margin-top: 15px; }
.edit-btn { background: #ff9f1c; color: white; width: auto; padding: 5px 15px; }

/* DASHBOARD */
.upcoming { display: flex; gap: 12px; margin-bottom: 20px; }
.up-box {
    flex: 1;
    background: #1b263b;
    color: #fff;
    border-radius: 15px;
    padding: 15px;
    text-align: center;
}
.up-title { font-size: 11px; text-transform: uppercase; color: #a2a2a2; margin-bottom: 5px; }
.up-bus-name { font-size: 14px; font-weight: bold; color: var(--accent); }
.up-city { font-size: 12px; margin: 4px 0; }
.count { font-size: 20px; font-weight: bold; font-family: monospace; color: #fff; margin-top: 5px; }
.up-date-small { font-size: 10px; color: #888; }

/* TIMELINE */
.timeline-item { display: flex; align-items: center; position: relative; padding-bottom: 10px; }
.dot { width: 10px; height: 10px; background: var(--secondary); border-radius: 50%; margin-right: 12px; }
.badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; text-transform: uppercase; }
.boarding { background: #e9f5f3; color: #2a9d8f; }
.dropping { background: #fef2f2; color: #e63946; }

/* MAP MODAL */
.map-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; z-index: 9999; }
.map-close { position: absolute; top: 15px; right: 15px; background: var(--accent); width: 40px; height: 40px; border-radius: 50%; }
#mapFrame { width: 100%; height: 100%; border: none; }

.hidden { display: none; }
label { font-size: 12px; font-weight: bold; color: #666; margin-left: 5px; }
</style>
</head>

<body>
<div class="container">

<h2>üöå Smart Bus Tracking</h2>

<div class="upcoming">
  <div class="up-box" id="upDep">
      <div class="up-title">Next Departure</div>
      <div id="depInfo">Calculating...</div>
      <div class="count" id="depCount">00:00:00</div>
  </div>
  <div class="up-box" id="upArr">
      <div class="up-title">Next Arrival</div>
      <div id="arrInfo">Calculating...</div>
      <div class="count" id="arrCount">00:00:00</div>
  </div>
</div>

<input id="search" placeholder="üîç Search bus, city, or boarding point...">

<div id="busList"></div>

<hr style="margin: 40px 0; border: 0; border-top: 1px solid #ddd;">

<div id="loginBox" class="card">
  <h3>üîê Admin Access</h3>
  <input id="email" placeholder="Admin Email">
  <input id="pass" type="password" placeholder="Password">
  <button id="loginBtn" style="background:var(--secondary); color:white;">Login</button>
</div>

<div id="adminPanel" class="hidden card" style="border-left-color: #e76f51;">
  <h3 id="adminTitle">üõ† Add New Bus</h3>
  <label>Travels Name</label>
  <input id="travel" placeholder="e.g. TTT Travels">
  
  <div class="row">
    <div style="flex:1">
      <label>Departure City</label>
      <input id="depCity" placeholder="Source City">
      <input id="depTime" placeholder="05:50 PM">
    </div>
    <div style="flex:1">
      <label>Destination City</label>
      <input id="destCity" placeholder="Destination City">
      <input id="destTime" placeholder="06:55 AM">
    </div>
  </div>

  <h4>Route Via (Stops)</h4>
  <div id="routes"></div>
  <button onclick="addRouteUI()" style="background:#eee; color:#333; margin-top:0;">‚ûï Add Via Stop</button>

  <label style="display:block; margin-top:15px;">Live Tracking Link</label>
  <input id="link" placeholder="Google Maps Share Link">

  <input type="hidden" id="editingBusId">
  
  <div class="row" style="margin-top:20px;">
    <button id="saveBtn" onclick="saveBus()" style="background:var(--primary); color:white; flex:2">üíæ Save Bus</button>
    <button id="cancelEdit" class="hidden" onclick="resetAdmin()" style="background:#666; color:white; flex:1">Cancel</button>
  </div>
  
  <button onclick="logout()" style="background:#e63946; color:white; margin-top:20px;">Logout</button>
</div>

</div>

<div class="map-modal" id="mapModal">
  <button class="map-close" onclick="closeMap()">‚úï</button>
  <iframe id="mapFrame"></iframe>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",
  authDomain: "smart-bus-tracking-2ba21.firebaseapp.com",
  projectId: "smart-bus-tracking-2ba21"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let data = [];

/* --- TIME LOGIC --- */
function getNextOccurrence(timeStr) {
    const now = new Date();
    let [time, modifier] = timeStr.split(" ");
    let [hours, minutes] = time.split(":").map(Number);
    
    if (modifier === "PM" && hours !== 12) hours += 12;
    if (modifier === "AM" && hours === 12) hours = 0;

    let target = new Date();
    target.setHours(hours, minutes, 0, 0);

    // If time has already passed today, set it for tomorrow
    if (target < now) {
        target.setDate(target.getDate() + 1);
    }
    return target;
}

function formatCountdown(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return `${h.toString().padStart(2,'0')}h ${m.toString().padStart(2,'0')}m ${s.toString().padStart(2,'0')}s`;
}

/* --- DASHBOARD UPDATE --- */
function updateDashboard() {
    if (!data.length) return;

    const now = new Date();

    // Map all buses to their next departure/arrival times
    let depList = data.map(b => ({
        bus: b,
        targetDate: getNextOccurrence(b.depTime),
        type: 'Departure'
    })).sort((a, b) => a.targetDate - b.targetDate);

    let arrList = data.map(b => ({
        bus: b,
        targetDate: getNextOccurrence(b.destTime),
        type: 'Arrival'
    })).sort((a, b) => a.targetDate - b.targetDate);

    const nextDep = depList[0];
    const nextArr = arrList[0];

    // Update Departure UI
    document.getElementById('depInfo').innerHTML = `
        <div class="up-bus-name">${nextDep.bus.travel}</div>
        <div class="up-city">${nextDep.bus.depCity} (${nextDep.bus.depTime})</div>
        <div class="up-date-small">${nextDep.targetDate.toLocaleDateString()}</div>
    `;

    // Update Arrival UI
    document.getElementById('arrInfo').innerHTML = `
        <div class="up-bus-name">${nextArr.bus.travel}</div>
        <div class="up-city">${nextArr.bus.destCity} (${nextArr.bus.destTime})</div>
        <div class="up-date-small">${nextArr.targetDate.toLocaleDateString()}</div>
    `;

    // Static interval for countdown numbers
    if (window.timerInterval) clearInterval(window.timerInterval);
    window.timerInterval = setInterval(() => {
        const dDiff = nextDep.targetDate - new Date();
        const aDiff = nextArr.targetDate - new Date();
        
        document.getElementById('depCount').innerText = formatCountdown(dDiff);
        document.getElementById('arrCount').innerText = formatCountdown(aDiff);
        
        // Refresh full logic if a bus just "departed" (timer hits zero)
        if (dDiff < 0 || aDiff < 0) updateDashboard();
    }, 1000);
}

/* --- ADMIN HANDLERS --- */
window.addRouteUI = (city = "", time = "", type = "Boarding") => {
    const d = document.createElement("div");
    d.className = "row stop-row";
    d.innerHTML = `
        <div style="flex:2"><label>City</label><input class="c-city" value="${city}"></div>
        <div style="flex:1"><label>Time</label><input class="c-time" value="${time}"></div>
        <div style="flex:1">
            <label>Type</label>
            <select class="c-type">
                <option value="Boarding" ${type==='Boarding'?'selected':''}>Boarding</option>
                <option value="Dropping" ${type==='Dropping'?'selected':''}>Dropping</option>
            </select>
        </div>
        <button onclick="this.parentElement.remove()" style="background:#ff4d4d; color:white; width:40px; margin-bottom:8px">X</button>
    `;
    document.getElementById('routes').appendChild(d);
};

window.saveBus = async () => {
    const id = document.getElementById('editingBusId').value;
    const viaStops = [];
    document.querySelectorAll(".stop-row").forEach(row => {
        viaStops.push({
            city: row.querySelector(".c-city").value,
            time: row.querySelector(".c-time").value,
            type: row.querySelector(".c-type").value
        });
    });

    const busObj = {
        travel: document.getElementById('travel').value,
        depCity: document.getElementById('depCity').value,
        depTime: document.getElementById('depTime').value,
        destCity: document.getElementById('destCity').value,
        destTime: document.getElementById('destTime').value,
        route: viaStops,
        link: document.getElementById('link').value
    };

    try {
        if (id) {
            await updateDoc(doc(db, "buses", id), busObj);
            alert("Updated!");
        } else {
            await addDoc(collection(db, "buses"), busObj);
            alert("Added!");
        }
        resetAdmin();
    } catch(e) { alert(e.message); }
};

window.editBus = (id) => {
    const b = data.find(x => x.id === id);
    if(!b) return;
    document.getElementById('editingBusId').value = id;
    document.getElementById('travel').value = b.travel;
    document.getElementById('depCity').value = b.depCity;
    document.getElementById('depTime').value = b.depTime;
    document.getElementById('destCity').value = b.destCity;
    document.getElementById('destTime').value = b.destTime;
    document.getElementById('link').value = b.link;
    document.getElementById('routes').innerHTML = "";
    if(b.route) b.route.forEach(s => addRouteUI(s.city, s.time, s.type));
    document.getElementById('adminTitle').innerText = "üìù Edit " + b.travel;
    document.getElementById('cancelEdit').classList.remove('hidden');
    document.getElementById('adminPanel').scrollIntoView({behavior:'smooth'});
};

window.resetAdmin = () => {
    document.getElementById('editingBusId').value = "";
    document.getElementById('adminTitle').innerText = "üõ† Add New Bus";
    document.getElementById('cancelEdit').classList.add('hidden');
    document.getElementById('routes').innerHTML = "";
    document.querySelectorAll('#adminPanel input').forEach(i => i.value="");
};

/* --- UI RENDER --- */
function renderList() {
    const busList = document.getElementById('busList');
    const term = document.getElementById('search').value.toLowerCase();
    const isAdmin = auth.currentUser !== null;
    busList.innerHTML = "";

    const filtered = data.filter(b => 
        b.travel.toLowerCase().includes(term) || 
        b.depCity.toLowerCase().includes(term) ||
        b.destCity.toLowerCase().includes(term)
    );

    filtered.forEach(b => {
        const c = document.createElement("div");
        c.className = "card";
        const viaHtml = b.route ? b.route.map(s => `
            <div class="timeline-item">
                <div class="dot"></div>
                <div style="flex:1; font-size:14px"><b>${s.city}</b> - ${s.time}</div>
                <span class="badge ${s.type.toLowerCase()}">${s.type}</span>
            </div>
        `).join('') : '';

        c.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:start">
                <div>
                    <h3 style="margin:0 0 5px 0; color:var(--secondary)">üöå ${b.travel}</h3>
                    <div style="font-size:15px; font-weight:bold; color:var(--primary)">
                        ${b.depCity} (${b.depTime}) ‚ûî ${b.destCity} (${b.destTime})
                    </div>
                </div>
                ${isAdmin ? `<button class="edit-btn" onclick="editBus('${b.id}')">Edit</button>` : ''}
            </div>
            <div style="margin: 15px 0; padding-left:5px; border-left: 2px dashed #ccc;">${viaHtml}</div>
            <button class="track-btn" onclick="openMap('${b.link}')">üìç View Live Location</button>
        `;
        busList.appendChild(c);
    });
}

/* --- APP INIT --- */
onAuthStateChanged(auth, u => {
    document.getElementById('loginBox').classList.toggle('hidden', !!u);
    document.getElementById('adminPanel').classList.toggle('hidden', !u);
    renderList();
});

document.getElementById('loginBtn').onclick = () => {
    signInWithEmailAndPassword(auth, email.value, pass.value).catch(e => alert(e.message));
};
window.logout = () => signOut(auth);
document.getElementById('search').oninput = renderList;

onSnapshot(collection(db, "buses"), snap => {
    data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderList();
    updateDashboard();
});

window.openMap = url => {
    document.getElementById('mapFrame').src = url;
    document.getElementById('mapModal').style.display = "block";
};
window.closeMap = () => {
    document.getElementById('mapFrame').src = "";
    document.getElementById('mapModal').style.display = "none";
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracking Pro</title>

<style>
:root {
    --primary: #2a9d8f;
    --secondary: #023047;
    --accent: #ffd60a;
    --bg: #f0f2f5;
    --card-bg: #ffffff;
}

body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: #333;
}

.container { max-width: 1000px; margin: auto; padding: 20px; }
h2 { text-align: center; color: var(--secondary); margin-bottom: 25px; }

/* SEARCH SECTION */
.search-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 10px;
    background: #fff;
    padding: 15px;
    border-radius: 15px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    margin-bottom: 20px;
}

.city-filter-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 10px;
}

input, select, button {
    width: 100%;
    padding: 12px;
    margin: 5px 0;
    border-radius: 10px;
    border: 1px solid #ddd;
    font-size: 14px;
    box-sizing: border-box;
}

button { cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
button:active { transform: scale(0.98); }

/* CARDS */
.card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    margin: 15px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border-left: 5px solid var(--primary);
}

.track-btn { background: var(--primary); color: #fff; margin-top: 15px; }

/* DASHBOARD */
.upcoming { display: flex; gap: 12px; margin-bottom: 20px; }
.up-box {
    flex: 1;
    background: #1b263b;
    color: #fff;
    border-radius: 15px;
    padding: 15px;
    text-align: center;
}
.count { font-size: 20px; font-weight: bold; font-family: monospace; color: var(--accent); }

.timeline-item { display: flex; align-items: center; padding-bottom: 8px; font-size: 13px; }
.dot { width: 8px; height: 8px; background: var(--secondary); border-radius: 50%; margin-right: 10px; }
.badge { font-size: 9px; padding: 2px 5px; border-radius: 4px; margin-left: auto; }
.boarding { background: #e9f5f3; color: #2a9d8f; }
.dropping { background: #fef2f2; color: #e63946; }

.hidden { display: none; }
@media(max-width: 768px) { .search-grid, .city-filter-row { grid-template-columns: 1fr; } }
</style>
</head>

<body>
<div class="container">

<h2>üöå Smart Bus Tracking</h2>

<div class="upcoming">
  <div class="up-box" id="upDepBox">
      <div style="font-size:10px; color:#aaa">NEXT DEPARTURE</div>
      <div id="depInfo">Loading...</div>
      <div class="count" id="depCount">00:00:00</div>
  </div>
  <div class="up-box" id="upArrBox">
      <div style="font-size:10px; color:#aaa">NEXT ARRIVAL</div>
      <div id="arrInfo">Loading...</div>
      <div class="count" id="arrCount">00:00:00</div>
  </div>
</div>

<div class="search-section">
    <div class="search-grid">
        <input id="search" placeholder="üîç Search bus, city, or via routes...">
        <select id="stopType">
            <option value="All">All Stops</option>
            <option value="Boarding">Boarding Only</option>
            <option value="Dropping">Dropping Only</option>
        </select>
        <select id="operatorFilter">
            <option value="All">All Operators</option>
        </select>
    </div>
    <div class="city-filter-row">
        <select id="fromCity">
            <option value="">Select Boarding City</option>
        </select>
        <select id="toCity">
            <option value="">Select Destination</option>
        </select>
    </div>
    <button onclick="resetFilters()" style="background:#ddd; color:#333; margin-top:10px; padding:8px">Clear Filters</button>
</div>

<div id="busList"></div>

<hr style="margin: 40px 0; border: 0; border-top: 1px solid #ddd;">

<div id="loginBox" class="card">
  <h3>üîê Admin Access</h3>
  <input id="email" placeholder="Admin Email">
  <input id="pass" type="password" placeholder="Password">
  <button id="loginBtn" style="background:var(--secondary); color:white;">Login</button>
</div>

<div id="adminPanel" class="hidden card">
  <h3 id="adminTitle">üõ† Bus Management</h3>
  <input id="travel" placeholder="Operator/Travels Name">
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
    <input id="depCity" placeholder="Source City">
    <input id="depTime" placeholder="Departure Time (e.g. 10:00 AM)">
    <input id="destCity" placeholder="Destination City">
    <input id="destTime" placeholder="Arrival Time (e.g. 08:00 PM)">
  </div>
  <div id="routes"></div>
  <button onclick="addRouteUI()" style="background:#eee; color:#333">‚ûï Add Via Stop</button>
  <input id="link" placeholder="Tracking Link">
  <input type="hidden" id="editingBusId">
  <button onclick="saveBus()" style="background:var(--primary); color:white; margin-top:10px">üíæ Save Bus</button>
  <button onclick="logout()" style="background:#e63946; color:white; margin-top:20px">Logout</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = { apiKey: "AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0", authDomain: "smart-bus-tracking-2ba21.firebaseapp.com", projectId: "smart-bus-tracking-2ba21" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let data = [];

/* FILTER EVENT LISTENERS */
document.getElementById('search').oninput = renderList;
document.getElementById('stopType').onchange = renderList;
document.getElementById('operatorFilter').onchange = renderList;
document.getElementById('fromCity').onchange = () => { updateToCityDropdown(); renderList(); };
document.getElementById('toCity').onchange = renderList;

window.resetFilters = () => {
    document.getElementById('search').value = "";
    document.getElementById('stopType').value = "All";
    document.getElementById('operatorFilter').value = "All";
    document.getElementById('fromCity').value = "";
    document.getElementById('toCity').value = "";
    updateToCityDropdown();
    renderList();
};

/* --- DYNAMIC DROPDOWN LOGIC --- */
function updateSearchDropdowns() {
    const operators = new Set();
    const allCities = new Set();
    
    data.forEach(b => {
        operators.add(b.travel);
        allCities.add(b.depCity);
        allCities.add(b.destCity);
        if(b.route) b.route.forEach(r => allCities.add(r.city));
    });

    // Update Operator List
    const opFilter = document.getElementById('operatorFilter');
    const currentOp = opFilter.value;
    opFilter.innerHTML = '<option value="All">All Operators</option>';
    Array.from(operators).sort().forEach(op => {
        opFilter.innerHTML += `<option value="${op}" ${op === currentOp ? 'selected' : ''}>${op}</option>`;
    });

    // Update Boarding City List
    const fromFilter = document.getElementById('fromCity');
    const currentFrom = fromFilter.value;
    fromFilter.innerHTML = '<option value="">Select Boarding City</option>';
    Array.from(allCities).sort().forEach(city => {
        fromFilter.innerHTML += `<option value="${city}" ${city === currentFrom ? 'selected' : ''}>${city}</option>`;
    });
    
    updateToCityDropdown();
}

function updateToCityDropdown() {
    const fromCity = document.getElementById('fromCity').value;
    const toFilter = document.getElementById('toCity');
    const possibleDestinations = new Set();

    if (!fromCity) {
        toFilter.innerHTML = '<option value="">Select Destination</option>';
        return;
    }

    data.forEach(b => {
        const busCities = [b.depCity, ...(b.route?.map(r => r.city) || []), b.destCity];
        if (busCities.includes(fromCity)) {
            const idx = busCities.indexOf(fromCity);
            // Only cities appearing AFTER the boarding point are valid destinations
            busCities.slice(idx + 1).forEach(c => possibleDestinations.add(c));
        }
    });

    toFilter.innerHTML = '<option value="">Select Destination</option>';
    Array.from(possibleDestinations).sort().forEach(city => {
        toFilter.innerHTML += `<option value="${city}">${city}</option>`;
    });
}

/* --- MAIN FILTERING ENGINE --- */
function renderList() {
    const term = document.getElementById('search').value.toLowerCase();
    const stopType = document.getElementById('stopType').value;
    const operator = document.getElementById('operatorFilter').value;
    const from = document.getElementById('fromCity').value;
    const to = document.getElementById('toCity').value;
    const isAdmin = auth.currentUser !== null;

    const filtered = data.filter(b => {
        // 1. Text Search (Travels, Dep, Dest, Via)
        const allVia = b.route?.map(r => r.city.toLowerCase()).join(' ') || '';
        const textMatch = b.travel.toLowerCase().includes(term) || b.depCity.toLowerCase().includes(term) || 
                          b.destCity.toLowerCase().includes(term) || allVia.includes(term);
        
        // 2. Operator Filter
        const opMatch = (operator === "All" || b.travel === operator);

        // 3. Stop Type Filter
        let typeMatch = true;
        if (stopType !== "All") {
            const hasBoarding = b.depCity.toLowerCase().includes(term) || b.route?.some(r => r.type === "Boarding" && r.city.toLowerCase().includes(term));
            const hasDropping = b.destCity.toLowerCase().includes(term) || b.route?.some(r => r.type === "Dropping" && r.city.toLowerCase().includes(term));
            typeMatch = (stopType === "Boarding" ? hasBoarding : hasDropping);
        }

        // 4. Source-to-Destination Filter
        let routeMatch = true;
        if (from || to) {
            const busCities = [b.depCity, ...(b.route?.map(r => r.city) || []), b.destCity];
            if (from && to) {
                const fIdx = busCities.indexOf(from);
                const tIdx = busCities.indexOf(to);
                routeMatch = (fIdx !== -1 && tIdx !== -1 && fIdx < tIdx);
            } else if (from) {
                routeMatch = busCities.includes(from);
            }
        }

        return textMatch && opMatch && typeMatch && routeMatch;
    });

    const busList = document.getElementById('busList');
    busList.innerHTML = filtered.length ? "" : "<p style='text-align:center; padding:20px;'>No buses found matching these filters.</p>";
    
    filtered.forEach(b => {
        const c = document.createElement("div");
        c.className = "card";
        const viaHtml = b.route ? b.route.map(s => `
            <div class="timeline-item">
                <div class="dot"></div>
                <div style="flex:1"><b>${s.city}</b> - ${s.time}</div>
                <span class="badge ${s.type.toLowerCase()}">${s.type}</span>
            </div>
        `).join('') : '';

        c.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:start">
                <div>
                    <h3 style="margin:0; color:var(--secondary)">üöå ${b.travel}</h3>
                    <div style="font-size:14px; font-weight:bold; color:var(--primary); margin:5px 0">
                        ${b.depCity} (${b.depTime}) ‚ûî ${b.destCity} (${b.destTime})
                    </div>
                </div>
                ${isAdmin ? `<button style="width:auto; padding:5px 10px; background:#ff9f1c; color:#fff" onclick="editBus('${b.id}')">Edit</button>` : ''}
            </div>
            <div style="margin:10px 0; border-left:1px dashed #ccc; padding-left:10px">${viaHtml}</div>
            <button class="track-btn" onclick="openMap('${b.link}')">üìç View Live Location</button>
        `;
        busList.appendChild(c);
    });
}

/* --- FIREBASE & OTHER HELPERS (Keep your existing updateDashboard, saveBus, etc.) --- */
onSnapshot(collection(db, "buses"), snap => {
    data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    updateSearchDropdowns();
    renderList();
    if(window.updateDashboard) updateDashboard(); // Call your existing dashboard function
});

// [Rest of your saveBus, editBus, addRouteUI, login/logout functions go here]
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUS TRACKING</title>
    <style>
        :root { --primary: #2a9d8f; --secondary: #023047; --accent: #ffd60a; --bg: #0f172a; --card-bg: #1e293b; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #f8fafc; }
        
        /* Header Fix */
        header { background: #1e293b; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 1000; }
        .header-right { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        #liveClock { font-family: monospace; font-weight: bold; color: var(--accent); font-size: 18px; text-shadow: 0 0 10px rgba(255, 214, 10, 0.3); }
        #userEmailDisplay { font-size: 11px; color: #94a3b8; }

        .container { max-width: 800px; margin: auto; padding: 15px; }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 14px; }

        /* Dashboard boxes from your image */
        .upcoming { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .up-box { background: #1e293b; border-radius: 20px; padding: 20px; text-align: center; border: 1px solid #334155; min-height: 180px; display: flex; flex-direction: column; justify-content: center; }
        .up-box .label { font-size: 11px; color: #94a3b8; text-transform: uppercase; margin-bottom: 5px; }
        .up-box b { font-size: 16px; color: var(--accent); display: block; margin-bottom: 10px; }
        .count { font-size: 24px; font-weight: bold; font-family: monospace; color: #fff; line-height: 1.2; }

        /* Search area styling */
        .search-container { background: #1e293b; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .search-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 8px; }
        .city-filter-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        /* Modern Card with status */
        .card { background: var(--card-bg); padding: 20px; border-radius: 18px; margin-bottom: 15px; border: 1px solid #334155; }
        .bus-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .travel-name { font-size: 18px; font-weight: 800; color: #fff; }
        .status-badge { font-size: 10px; padding: 4px 10px; border-radius: 20px; font-weight: bold; margin-top: 5px; display: inline-block; }
        .status-waiting { background: #334155; color: #cbd5e1; }
        .status-scheduled { background: #78350f; color: #fcd34d; }
        .status-on-route { background: #064e3b; color: #6ee7b7; border: 1px solid #10b981; }
        .dot { height: 6px; width: 6px; background: #10b981; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }

        .route-visual { display: flex; align-items: center; justify-content: space-between; margin: 15px 0; }
        .line { flex: 1; height: 1px; background: #334155; position: relative; margin: 0 10px; }
        .line::after { content: '‚ñ∂'; position: absolute; top: -7px; left: 45%; font-size: 10px; color: var(--primary); }

        #welcomeArea { text-align: center; padding: 40px; color: #94a3b8; }
        .map-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; z-index: 2000; }
        .map-close { position: absolute; top: 15px; right: 15px; background: var(--accent); border: none; width: 40px; height: 40px; border-radius: 50%; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <h3 style="margin:0;">üöç BUS TRACKING</h3>
    <div class="header-right">
        <div id="liveClock">00:00:00</div>
        <div id="loggedInLinks" class="hidden">
            <span id="userEmailDisplay"></span>
            <button onclick="logout()" style="background:#ef4444; border:none; color:white; padding:4px 10px; border-radius:5px; font-size:11px; cursor:pointer;">Log Out</button>
        </div>
    </div>
</header>

<div class="container">
    <div id="authWall">
        <div style="text-align:center; padding:40px; background:#1e293b; border-radius:20px; margin-top:50px;">
            <h2>Admin Login</h2>
            <input type="email" id="uEmail" placeholder="Login ID">
            <input type="password" id="uPass" placeholder="Password">
            <button class="btn-main" style="width:100%; margin-top:10px;" id="loginBtn">Login</button>
        </div>
    </div>

    <div id="mainContent" class="hidden">
        <div class="upcoming">
            <div class="up-box">
                <span class="label">Next Departure</span>
                <b id="depBusName">Ready...</b>
                <div id="depCounter" class="count">00h 00m 00s</div>
            </div>
            <div class="up-box">
                <span class="label">Next Arrival</span>
                <b id="arrBusName">Ready...</b>
                <div id="arrCounter" class="count">00h 00m 00s</div>
            </div>
        </div>

        <div id="adminPortal" class="hidden" style="background:#1e293b; padding:15px; border-radius:15px; margin-bottom:20px; border:1px dashed var(--primary);">
            <input id="travel" placeholder="Travels Name">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                <select id="depCityAdmin"></select>
                <input id="depTimeInput" placeholder="Time (07:00 PM)">
                <select id="destCityAdmin"></select>
                <input id="destTimeInput" placeholder="Time (06:00 AM)">
            </div>
            <div id="dynamicStops"></div>
            <button onclick="addStopField()" style="width:100%; margin:10px 0; background:#334155; color:white; border:none; padding:8px; border-radius:5px;">+ Add Stop</button>
            <input id="trackLink" placeholder="Live Link">
            <input type="hidden" id="editingBusId">
            <button onclick="saveBus()" class="btn-main" style="width:100%">Save Bus</button>
        </div>

        <div class="search-container">
            <div class="search-grid">
                <input id="searchBox" placeholder="üîç Search bus...">
                <select id="stopFilter"><option value="All">All</option><option value="Boarding">Boarding</option><option value="Dropping">Dropping</option></select>
                <select id="sortOption"><option value="none">Sort</option><option value="early">Early</option></select>
                <button onclick="location.reload()" class="btn-main" style="background:#475569">Clear</button>
            </div>
            <div class="city-filter-row">
                <select id="fromCity"><option value="">Select Boarding City</option></select>
                <select id="toCity"><option value="">Select Destination</option></select>
            </div>
        </div>

        <div id="welcomeArea">
            <h2>Search to get results</h2>
        </div>
        <div id="busDisplayArea"></div>
    </div>
</div>

<div class="map-modal" id="mapModal">
    <button class="map-close" onclick="closeMap()">‚úï</button>
    <iframe id="mapFrame" style="width:100%; height:100%; border:none;"></iframe>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = { apiKey: "AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0", authDomain: "smart-bus-tracking-2ba21.firebaseapp.com", projectId: "smart-bus-tracking-2ba21" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const ADMIN_EMAIL = "admin@wintracking.com"; 
let busData = [];
let allCities = new Set();

// Fixed Clock
setInterval(() => { 
    document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('en-GB'); 
    rebuildUI(); 
}, 1000);

onAuthStateChanged(auth, user => {
    if (user) {
        document.getElementById('mainContent').classList.remove('hidden');
        document.getElementById('authWall').classList.add('hidden');
        document.getElementById('loggedInLinks').classList.remove('hidden');
        document.getElementById('userEmailDisplay').innerText = user.email;
        if(user.email === ADMIN_EMAIL) document.getElementById('adminPortal').classList.remove('hidden');
    } else {
        document.getElementById('mainContent').classList.add('hidden');
        document.getElementById('authWall').classList.remove('hidden');
    }
});

function parseTimeToDate(timeStr) {
    if (!timeStr || !timeStr.includes(" ")) return null;
    const now = new Date();
    let [time, mod] = timeStr.split(" ");
    let [h, m] = time.split(":").map(Number);
    if (mod.toUpperCase() === "PM" && h !== 12) h += 12;
    if (mod.toUpperCase() === "AM" && h === 12) h = 0;
    let target = new Date(); target.setHours(h, m, 0, 0);
    return target;
}

function getBusStatus(bus) {
    const now = new Date();
    const dep = parseTimeToDate(bus.depTime);
    const arr = parseTimeToDate(bus.destTime);
    if (arr < dep) arr.setDate(arr.getDate() + 1);

    if (now < dep) {
        const diff = (dep - now) / (1000 * 60 * 60);
        return diff <= 5 ? `<span class="status-badge status-scheduled">Scheduled</span>` : `<span class="status-badge status-waiting">Waiting</span>`;
    } else if (now < arr) {
        return `<span class="status-badge status-on-route"><span class="dot"></span> Departed</span>`;
    }
    return `<span class="status-badge status-waiting">Arrived</span>`;
}

function rebuildUI() {
    const term = searchBox.value.toLowerCase();
    const from = fromCity.value;
    const listArea = document.getElementById('busDisplayArea');
    const isAdmin = auth.currentUser?.email === ADMIN_EMAIL;
    
    if (!term && !from) { welcomeArea.classList.remove('hidden'); listArea.innerHTML = ""; return; }
    welcomeArea.classList.add('hidden');

    let filtered = busData.filter(b => b.travel.toLowerCase().includes(term) || b.depCity.toLowerCase().includes(term));

    listArea.innerHTML = "";
    filtered.forEach(b => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
            <div class="bus-header">
                <div>
                    <div class="travel-name">üöç ${b.travel}</div>
                    ${getBusStatus(b)}
                </div>
                ${isAdmin ? `<button onclick="editBus('${b.id}')" style="color:cyan; background:none; border:none; cursor:pointer;">Edit</button>` : ''}
            </div>
            <div class="route-visual">
                <div><b>${b.depCity}</b><div style="font-size:11px;">${b.depTime}</div></div>
                <div class="line"></div>
                <div><b>${b.destCity}</b><div style="font-size:11px;">${b.destTime}</div></div>
            </div>
            <button class="btn-main" style="width:100%" onclick="openMap('${b.link}')">üìç Live Track</button>
        `;
        listArea.appendChild(card);
    });
}

function updateDashboard() {
    const now = new Date();
    const deps = busData.map(b => ({ b, t: parseTimeToDate(b.depTime) })).filter(x => x.t && x.t > now).sort((a,b) => a.t - b.t);
    const arrs = busData.map(b => ({ b, t: parseTimeToDate(b.destTime) })).filter(x => x.t && x.t > now).sort((a,b) => a.t - b.t);
    
    const updateBox = (id, timerId, list) => {
        if (list.length > 0) {
            document.getElementById(id).innerText = list[0].b.travel;
            const diff = Math.max(0, Math.floor((list[0].t - new Date()) / 1000));
            const h = Math.floor(diff/3600), m = Math.floor((diff%3600)/60), s = diff%60;
            document.getElementById(timerId).innerText = `${h}h ${m}m ${s}s`;
        } else {
            document.getElementById(id).innerText = "Ready...";
            document.getElementById(timerId).innerText = "00h 00m 00s";
        }
    };
    updateBox('depBusName', 'depCounter', deps);
    updateBox('arrBusName', 'arrCounter', arrs);
}

onSnapshot(collection(db, "buses"), snap => {
    busData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    allCities.clear();
    busData.forEach(b => { allCities.add(b.depCity); allCities.add(b.destCity); });
    
    const opts = `<option value="">City</option>` + Array.from(allCities).sort().map(c => `<option value="${c}">${c}</option>`).join('');
    ['depCityAdmin', 'destCityAdmin', 'fromCity', 'toCity'].forEach(id => document.getElementById(id).innerHTML = opts);
    
    updateDashboard();
    rebuildUI();
});

// Admin functions
window.addStopField = () => {
    const div = document.createElement("div");
    div.className = "stop-entry";
    div.style.display = "flex"; div.style.gap = "5px"; div.style.marginTop = "5px";
    div.innerHTML = `<input class="s-city" placeholder="Stop City" style="flex:1"><input class="s-time" placeholder="Time" style="flex:1"><button onclick="this.parentElement.remove()" style="background:red; color:white; border:none; padding:5px;">X</button>`;
    document.getElementById('dynamicStops').appendChild(div);
};

window.saveBus = async () => {
    const id = editingBusId.value;
    const data = {
        travel: travel.value, depCity: depCityAdmin.value, depTime: depTimeInput.value,
        destCity: destCityAdmin.value, destTime: destTimeInput.value, link: trackLink.value
    };
    id ? await updateDoc(doc(db, "buses", id), data) : await addDoc(collection(db, "buses"), data);
    location.reload();
};

window.logout = () => signOut(auth);
window.openMap = (url) => { if(!url) return alert("No link"); mapFrame.src = url; mapModal.style.display = "block"; };
window.closeMap = () => { mapFrame.src = ""; mapModal.style.display = "none"; };

loginBtn.onclick = () => signInWithEmailAndPassword(auth, uEmail.value, uPass.value).catch(e => alert(e.message));
searchBox.oninput = rebuildUI;
fromCity.onchange = rebuildUI;
</script>
</body>
</html>

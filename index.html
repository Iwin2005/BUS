<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* ================= FIREBASE ================= */
const app = initializeApp({
 apiKey:"AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",
 authDomain:"smart-bus-tracking-2ba21.firebaseapp.com",
 projectId:"smart-bus-tracking-2ba21"
});
const db = getFirestore(app);
const auth = getAuth(app);

/* ================= STATE ================= */
let data = [];
let depTimer = null;
let arrTimer = null;

/* ================= TIME HELPERS ================= */
function toMinutes(t){
 if(!t) return null;
 const parts = t.split(" ");
 if(parts.length !== 2) return null;

 let [h,m] = parts[0].split(":").map(Number);
 const mod = parts[1];

 if(mod==="PM" && h!==12) h+=12;
 if(mod==="AM" && h===12) h=0;

 return h*60 + m;
}

function nextDateFromTime(time){
 const mins = toMinutes(time);
 if(mins===null) return null;

 const d = new Date();
 d.setHours(Math.floor(mins/60), mins%60, 0, 0);

 if(d.getTime() <= Date.now()){
   d.setDate(d.getDate()+1);
 }
 return d;
}

function formatDate(d){
 return d.toLocaleDateString("en-GB"); // DD/MM/YYYY
}

function countdown(target){
 const diff = target - Date.now();
 if(diff <= 0) return null;

 const s = Math.floor(diff/1000);
 return `${Math.floor(s/3600)}h ${Math.floor((s%3600)/60)}m ${s%60}s`;
}

/* ================= MAP ================= */
window.openMap = url=>{
 mapFrame.src = url;
 mapModal.style.display = "block";
};
window.closeMap = ()=>{
 mapFrame.src = "";
 mapModal.style.display = "none";
};

/* ================= UPCOMING LOGIC ================= */
function renderUpcoming(){
 clearInterval(depTimer);
 clearInterval(arrTimer);

 let depList = [];
 let arrList = [];

 data.forEach(bus=>{
   const boarding = bus.route?.find(r=>r.type==="boarding");
   const dropping = [...bus.route||[]].reverse().find(r=>r.type==="dropping");

   if(boarding){
     const d = nextDateFromTime(boarding.time);
     if(d) depList.push({bus, point:boarding, date:d});
   }
   if(dropping){
     const d = nextDateFromTime(dropping.time);
     if(d) arrList.push({bus, point:dropping, date:d});
   }
 });

 /* ===== DEPARTURE ===== */
 if(depList.length){
   const nextDepTime = Math.min(...depList.map(x=>x.date.getTime()));
   const showDep = depList.filter(x=>x.date.getTime()===nextDepTime);

   function updateDep(){
     const c = countdown(nextDepTime);
     if(!c){ renderUpcoming(); return; }

     upcomingDeparture.innerHTML = `
       <div class="upcoming-title">ğŸš¨ UPCOMING DEPARTURE</div>
       <div class="date-line">ğŸ“… ${formatDate(new Date(nextDepTime))}</div>
       ${showDep.map(o=>`
         ğŸšŒ ${o.bus.travel}<br>
         ğŸ“ ${o.point.city} â†’ ${o.bus.route.at(-1).city}<br>
         â° ${o.point.time}<br><br>
       `).join("")}
       â³ Departs in ${c}
     `;
   }
   updateDep();
   depTimer = setInterval(updateDep,1000);
 } else {
   upcomingDeparture.innerHTML = `
     <div class="upcoming-title">ğŸš¨ UPCOMING DEPARTURE</div>
     <div class="date-line">ğŸ“… â€”</div>
     No scheduled departure
   `;
 }

 /* ===== ARRIVAL ===== */
 if(arrList.length){
   const nextArrTime = Math.min(...arrList.map(x=>x.date.getTime()));
   const showArr = arrList.filter(x=>x.date.getTime()===nextArrTime);

   function updateArr(){
     const c = countdown(nextArrTime);
     if(!c){ renderUpcoming(); return; }

     upcomingArrival.innerHTML = `
       <div class="upcoming-title">ğŸš UPCOMING ARRIVAL</div>
       <div class="date-line">ğŸ“… ${formatDate(new Date(nextArrTime))}</div>
       ${showArr.map(o=>`
         ğŸšŒ ${o.bus.travel}<br>
         <div class="arrival-highlight">
           ğŸ ${o.point.city} â€“ ${o.point.time}
         </div><br>
       `).join("")}
       â³ Arrives in ${c}
     `;
   }
   updateArr();
   arrTimer = setInterval(updateArr,1000);
 } else {
   upcomingArrival.innerHTML = `
     <div class="upcoming-title">ğŸš UPCOMING ARRIVAL</div>
     <div class="date-line">ğŸ“… â€”</div>
     No scheduled arrival
   `;
 }
}

/* ================= AUTH ================= */
loginBtn.onclick = ()=>{
 signInWithEmailAndPassword(auth, adminEmail.value, adminPass.value)
 .catch(e=>alert(e.message));
};
window.logout = ()=>signOut(auth);

onAuthStateChanged(auth,u=>{
 loginBox.classList.toggle("hidden",!!u);
 adminPanel.classList.toggle("hidden",!u);
});

/* ================= DATA ================= */
onSnapshot(collection(db,"buses"), snap=>{
 data=[];
 snap.forEach(d=>data.push(d.data()));
 renderUpcoming();
});
</script>
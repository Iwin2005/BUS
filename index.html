<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracking</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: linear-gradient(to right, #fff3b0, #ffd60a);
}
.container {
    max-width: 900px;
    margin: auto;
    padding: 15px;
}
h2 {
    text-align: center;
    color: #3a2f00;
}
input, select, button {
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
}
button {
    cursor: pointer;
    font-weight: bold;
}
.card {
    background: #fff8dc;
    padding: 15px;
    border-radius: 10px;
    margin: 12px 0;
    box-shadow: 0 0 8px rgba(0,0,0,0.2);
}
.track-btn {
    background: #2a9d8f;
    color: white;
}
.sort-btn {
    background: #023047;
    color: white;
    width: 100%;
}
.row {
    display: flex;
    gap: 10px;
    margin: 10px 0;
}
.row input { flex: 2; }
.row select { flex: 1; }
@media (max-width: 600px) {
    .row { flex-direction: column; }
}
.hidden { display: none; }

/* MAP MODAL */
.map-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    z-index: 9999;
    flex-direction: column;
}
.map-header {
    height: 44px;
    background: #ffd60a;
    color: #023047;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 12px;
    font-weight: bold;
}
.map-header button {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
}
#mapFrame {
    flex: 1;
    width: 100%;
    border: none;
}
</style>
</head>

<body>
<div class="container">

<h2>ğŸšŒ Smart Bus Tracking</h2>

<div class="row">
    <input id="search" placeholder="Search city or travels">
    <select id="operatorSelect">
        <option value="">All Operators</option>
    </select>
    <select id="travelMode">
        <option value="departure">Departures</option>
        <option value="arrival">Arrivals</option>
        <option value="both">Both</option>
    </select>
</div>

<button class="sort-btn" id="sortBtn">â° Earliest First</button>

<div id="busList"></div>

</div>

<!-- MAP -->
<div id="mapModal" class="map-modal">
    <div class="map-header">
        <span>ğŸ—º Live Bus Tracking</span>
        <button onclick="closeMap()">âœ–</button>
    </div>
    <iframe id="mapFrame"></iframe>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",
  authDomain: "smart-bus-tracking-2ba21.firebaseapp.com",
  projectId: "smart-bus-tracking-2ba21"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data = [];
let activeSearch = "";
let activeOperator = "";
let travelMode = "departure";
let sortOrder = "asc";

const searchInput = document.getElementById("search");
const operatorSelect = document.getElementById("operatorSelect");
const travelModeSelect = document.getElementById("travelMode");
const busList = document.getElementById("busList");
const sortBtn = document.getElementById("sortBtn");

searchInput.addEventListener("input", e => {
    activeSearch = e.target.value.toLowerCase().trim();
    render();
});

operatorSelect.addEventListener("change", () => {
    activeOperator = operatorSelect.value;
    render();
});

travelModeSelect.addEventListener("change", () => {
    travelMode = travelModeSelect.value;
    render();
});

sortBtn.onclick = () => {
    sortOrder = sortOrder === "asc" ? "desc" : "asc";
    sortBtn.innerText = sortOrder === "asc"
        ? "â° Earliest First"
        : "â° Latest First";
    render();
};

function timeToMinutes(t) {
    let [time, mod] = t.split(" ");
    let [h, m] = time.split(":").map(Number);
    if (mod === "PM" && h !== 12) h += 12;
    if (mod === "AM" && h === 12) h = 0;
    return h * 60 + m;
}

function render() {
    busList.innerHTML = "";

    data.forEach(bus => {
        if (activeOperator && bus.travel !== activeOperator) return;

        const search = activeSearch;
        const first = bus.route[0];
        const last = bus.route.at(-1);

        const cityMatch = bus.route.find(r =>
            r.city.toLowerCase().includes(search)
        );

        const operatorMatch =
            bus.travel.toLowerCase().includes(search);

        let show = false;
        let label = "";

        if (!search) {
            show = true;
            label = "ğŸŸ¢ Departs from " + first.city;
        }
        else if (cityMatch) {
            if (travelMode === "departure" && cityMatch.city === first.city) {
                show = true;
                label = "ğŸŸ¢ Departs from " + first.city;
            }
            if (travelMode === "arrival" && cityMatch.city === last.city) {
                show = true;
                label = "ğŸ”µ Arrives at " + last.city;
            }
            if (travelMode === "both") {
                show = true;
                label =
                    cityMatch.city === first.city
                        ? "ğŸŸ¢ Departs from " + first.city
                        : cityMatch.city === last.city
                        ? "ğŸ”µ Arrives at " + last.city
                        : "â¡ Via " + cityMatch.city;
            }
        }
        else if (operatorMatch) {
            show = true;
            label = "ğŸšŒ Operator match";
        }

        if (!show) return;

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
            <h3>ğŸšŒ ${bus.travel}</h3>
            <b>${first.city} â†’ ${last.city}</b><br><br>
            ${bus.route.map((r,i)=>`
                ${i===0?"ğŸ“":i===bus.route.length-1?"ğŸ":"â¡"}
                ${r.city} ${r.time}
            `).join("<br>")}
            <br><br>
            <b>${label}</b><br><br>
            <button class="track-btn" onclick="openMap('${bus.link}')">Track</button>
        `;

        busList.appendChild(card);
    });
}

function renderOperatorDropdown() {
    const ops = [...new Set(data.map(b => b.travel))];
    operatorSelect.innerHTML = `<option value="">All Operators</option>`;
    ops.forEach(op => {
        const o = document.createElement("option");
        o.value = op;
        o.textContent = op;
        operatorSelect.appendChild(o);
    });
}

onSnapshot(collection(db, "buses"), snap => {
    data = [];
    snap.forEach(d => data.push(d.data()));
    renderOperatorDropdown();
    render();
});

/* MAP */
window.openMap = url => {
    mapFrame.src = url;
    mapModal.style.display = "flex";
    document.body.style.overflow = "hidden";
};

window.closeMap = () => {
    mapFrame.src = "";
    mapModal.style.display = "none";
    document.body.style.overflow = "auto";
};
</script>

</body>
</html>
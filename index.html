<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracking</title>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(to right,#2b1a00,#000);
  color:#fff;
}
.container{max-width:1000px;margin:auto;padding:15px}
h2{text-align:center}

input,select,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:8px;
  border:none;
  font-size:16px;
}
button{cursor:pointer;font-weight:bold}

.card{
  background:#111;
  padding:15px;
  border-radius:10px;
  margin:12px 0;
  box-shadow:0 0 8px rgba(255,214,10,.4)
}

.track-btn{background:#ffd60a;color:#000}
.sort-btn{background:#023047;color:#fff}

.row{display:flex;gap:12px}
@media(max-width:700px){.row{flex-direction:column}}

.upcoming{
  flex:1;
  background:#111;
  border-radius:12px;
  padding:15px;
  box-shadow:0 0 8px rgba(255,214,10,.4)
}
.up-title{text-align:center;font-size:18px;font-weight:bold;margin-bottom:10px}

/* MAP */
#mapModal{
  position:fixed; inset:0;
  background:#000;
  display:none; z-index:9999;
}
#mapModal button{
  position:absolute; top:12px; right:12px;
  width:40px;height:40px;border-radius:50%;
  font-size:20px;background:#ffd60a;border:none
}
#mapFrame{width:100%;height:100%;border:none}
</style>
</head>

<body>
<div class="container">

<h2>ğŸšŒ Smart Bus Tracking</h2>

<!-- UPCOMING -->
<div class="row">
  <div class="upcoming" id="upDep"></div>
  <div class="upcoming" id="upArr"></div>
</div>

<input id="search" placeholder="Search city or travels">

<div class="row">
<select id="operator"><option value="">All Operators</option></select>
<select id="journey">
<option value="both">Boarding & Dropping</option>
<option value="boarding">Boarding</option>
<option value="dropping">Dropping</option>
</select>
</div>

<button class="sort-btn" id="sort">â° Earliest First</button>

<div id="list"></div>

<!-- ADMIN -->
<div class="card">
<h3>ğŸ” Admin Login</h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button id="login">Login</button>
</div>

</div>

<!-- MAP -->
<div id="mapModal">
<button onclick="closeMap()">âœ–</button>
<iframe id="mapFrame"></iframe>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const app = initializeApp({
 apiKey:"AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",
 authDomain:"smart-bus-tracking-2ba21.firebaseapp.com",
 projectId:"smart-bus-tracking-2ba21"
});

const db=getFirestore(app);
const auth=getAuth(app);

let buses=[],searchTxt="",op="",journey="both",sort="asc";
let depTimer,arrTimer;

const toMin=t=>{
 let[p,m]=t.split(" ");let[h,mm]=p.split(":").map(Number);
 if(m==="PM"&&h!==12)h+=12;if(m==="AM"&&h===12)h=0;
 return h*60+mm;
}
const nextDate=t=>{
 const m=toMin(t);let d=new Date();
 d.setHours(Math.floor(m/60),m%60,0,0);
 if(d<Date.now()) d.setDate(d.getDate()+1);
 return d;
}

window.openMap=u=>{mapFrame.src=u;mapModal.style.display="block"}
window.closeMap=()=>{mapFrame.src="";mapModal.style.display="none"}

function renderUpcoming(){
 clearInterval(depTimer);clearInterval(arrTimer);
 const now=Date.now();

 const deps=[],arrs=[];
 buses.forEach(b=>{
  const bd=b.route.find(r=>r.type==="boarding");
  const dr=[...b.route].reverse().find(r=>r.type==="dropping");
  if(bd) deps.push({b,pt:bd,d:nextDate(bd.time)});
  if(dr) arrs.push({b,pt:dr,d:nextDate(dr.time)});
 });

 const dep=deps.sort((a,b)=>a.d-b.d)[0];
 const arr=arrs.sort((a,b)=>a.d-b.d)[0];

 function tick(){
  if(dep){
   let s=Math.floor((dep.d-Date.now())/1000);
   upDep.innerHTML=`
   <div class="up-title">ğŸš¨ UPCOMING DEPARTURE</div>
   ğŸ“… ${dep.d.toDateString()}<br>
   ğŸšŒ ${dep.b.travel}<br>
   ğŸ“ ${dep.pt.city} ${dep.pt.time}<br>
   â³ ${Math.floor(s/3600)}h ${Math.floor(s%3600/60)}m ${s%60}s`;
  }
  if(arr){
   let s=Math.floor((arr.d-Date.now())/1000);
   upArr.innerHTML=`
   <div class="up-title">ğŸš UPCOMING ARRIVAL</div>
   ğŸ“… ${arr.d.toDateString()}<br>
   ğŸšŒ ${arr.b.travel}<br>
   ğŸ ${arr.pt.city} ${arr.pt.time}<br>
   â³ ${Math.floor(s/3600)}h ${Math.floor(s%3600/60)}m ${s%60}s`;
  }
 }
 tick();depTimer=setInterval(tick,1000);arrTimer=depTimer;
}

function render(){
 list.innerHTML="";
 let f=buses.filter(b=>{
  if(op && b.travel!==op) return false;
  if(!searchTxt) return true;
  return b.travel.toLowerCase().includes(searchTxt)
   || b.route.some(r=>r.city.toLowerCase().includes(searchTxt));
 });

 f.sort((a,b)=>sort==="asc"
  ? toMin(a.route[0].time)-toMin(b.route[0].time)
  : toMin(b.route[0].time)-toMin(a.route[0].time)
 );

 if(!f.length){list.innerHTML="<div class='card'>No buses</div>";return}

 f.forEach(b=>{
  const c=document.createElement("div");
  c.className="card";
  c.innerHTML=`
  <h3>ğŸšŒ ${b.travel}</h3>
  ${b.route.map(r=>`${r.type==="boarding"?"ğŸŸ¢":r.type==="dropping"?"ğŸ”µ":"â¡"} ${r.city} ${r.time}`).join("<br>")}
  <br><br>
  <button class="track-btn" onclick="openMap('${b.link}')">Track</button>`;
  list.appendChild(c);
 });
}

search.oninput=e=>{searchTxt=e.target.value.toLowerCase();render()}
operator.onchange=e=>{op=e.target.value;render()}
journey.onchange=e=>{journey=e.target.value;render()}
sort.onclick=()=>{sort=sort==="asc"?"desc":"asc";render()}

login.onclick=()=>signInWithEmailAndPassword(auth,email.value,password.value).alert;

onSnapshot(collection(db,"buses"),snap=>{
 buses=[];snap.forEach(d=>buses.push(d.data()));
 operator.innerHTML='<option value="">All Operators</option>';
 [...new Set(buses.map(b=>b.travel))].forEach(o=>{
  operator.innerHTML+=`<option>${o}</option>`;
 });
 renderUpcoming();render();
});
</script>
</body>
</html>

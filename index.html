<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracking</title>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(to right,#2b1900,#000);
  color:#fff
}
.container{max-width:1000px;margin:auto;padding:15px}
h2{text-align:center}

input,select,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:8px;
  border:none;
  font-size:16px
}
button{cursor:pointer;font-weight:bold}

.sort-btn{background:#023047;color:#fff}
.track-btn{background:#ffd60a;color:#000}

.card{
  background:#111;
  padding:15px;
  border-radius:12px;
  margin:12px 0;
  box-shadow:0 0 10px rgba(255,214,10,.2)
}

.row{display:flex;gap:12px}
@media(max-width:800px){.row{flex-direction:column}}

.upcoming-wrapper{
  background:#111;
  border-radius:16px;
  padding:16px;
  display:flex;
  gap:16px;
  box-shadow:0 0 14px rgba(255,214,10,.3)
}
.upcoming-col{
  flex:1;
  text-align:center
}
.up-title{
  font-size:20px;
  font-weight:bold;
  margin-bottom:6px
}
.date-line{font-size:14px;margin-bottom:6px}
.countdown{margin-top:6px;font-weight:bold}

/* MAP */
.map-modal{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  z-index:9999;
}
.map-close{
  position:absolute;
  top:12px;
  right:12px;
  background:#ffd60a;
  border:none;
  font-size:22px;
  width:42px;
  height:42px;
  border-radius:50%;
  z-index:10000;
}
#mapFrame{width:100%;height:100%;border:none}

/* ADMIN */
.admin-box{background:#111;padding:15px;border-radius:12px;margin-top:20px}
.hidden{display:none}
</style>
</head>

<body>
<div class="container">

<h2>ğŸšŒ Smart Bus Tracking</h2>

<!-- UPCOMING COMBINED BOX -->
<div class="upcoming-wrapper">
  <div class="upcoming-col" id="upDep"></div>
  <div class="upcoming-col" id="upArr"></div>
</div>

<input id="search" placeholder="Search city or travels">

<div class="row">
  <select id="operator"></select>
  <select id="journey">
    <option value="both">Boarding & Dropping</option>
    <option value="boarding">Boarding</option>
    <option value="dropping">Dropping</option>
  </select>
</div>

<button id="sortBtn" class="sort-btn">â° Earliest First</button>

<div id="busList"></div>

<div class="admin-box">
<h3>ğŸ” Admin Login</h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button id="loginBtn">Login</button>

<div id="adminPanel" class="hidden">
  <h3>Admin Panel Active</h3>
  <button id="logoutBtn">Logout</button>
</div>
</div>

</div>

<!-- MAP -->
<div class="map-modal" id="mapModal">
<button class="map-close" onclick="closeMap()">âœ–</button>
<iframe id="mapFrame"></iframe>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const app = initializeApp({
 apiKey:"AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",
 authDomain:"smart-bus-tracking-2ba21.firebaseapp.com",
 projectId:"smart-bus-tracking-2ba21"
});
const db=getFirestore(app);
const auth=getAuth(app);

let data=[],sortAsc=true;
let depTimer=null,arrTimer=null;

const toMin=t=>{
 let[p,m]=t.split(" ");
 let[h,mm]=p.split(":").map(Number);
 if(m==="PM"&&h!==12)h+=12;
 if(m==="AM"&&h===12)h=0;
 return h*60+mm;
};
const nextDate=time=>{
 let d=new Date();
 let m=toMin(time);
 d.setHours(Math.floor(m/60),m%60,0,0);
 if(d<Date.now())d.setDate(d.getDate()+1);
 return d;
};

function startCountdown(el,date,label){
 clearInterval(el.timer);
 const render=()=>{
  let diff=date-Date.now();
  if(diff<0)return;
  let s=Math.floor(diff/1000);
  el.querySelector(".countdown").innerText=
   `â³ ${label} in ${Math.floor(s/3600)}h ${Math.floor(s%3600/60)}m ${s%60}s`;
 };
 render();
 el.timer=setInterval(render,1000);
}

function renderUpcoming(){
 clearInterval(depTimer);clearInterval(arrTimer);

 let deps=[],arrs=[];
 data.forEach(b=>{
  let bd=b.route.find(r=>r.type==="boarding");
  let dr=[...b.route].reverse().find(r=>r.type==="dropping");
  if(bd)deps.push({b,p:bd,t:nextDate(bd.time)});
  if(dr)arrs.push({b,p:dr,t:nextDate(dr.time)});
 });

 deps.sort((a,b)=>a.t-b.t);
 arrs.sort((a,b)=>a.t-b.t);

 if(deps[0]){
  upDep.innerHTML=`
   <div class="up-title">ğŸš¨ UPCOMING DEPARTURE</div>
   <div class="date-line">ğŸ“… ${deps[0].t.toDateString()}</div>
   ğŸšŒ ${deps[0].b.travel}<br>
   ğŸ“ ${deps[0].p.city} ${deps[0].p.time}
   <div class="countdown"></div>
  `;
  startCountdown(upDep,deps[0].t,"Departs");
 }

 if(arrs[0]){
  upArr.innerHTML=`
   <div class="up-title">ğŸš UPCOMING ARRIVAL</div>
   <div class="date-line">ğŸ“… ${arrs[0].t.toDateString()}</div>
   ğŸšŒ ${arrs[0].b.travel}<br>
   ğŸ ${arrs[0].p.city} ${arrs[0].p.time}
   <div class="countdown"></div>
  `;
  startCountdown(upArr,arrs[0].t,"Arrives");
 }
}

window.openMap=u=>{mapFrame.src=u;mapModal.style.display="block"};
window.closeMap=()=>{mapFrame.src="";mapModal.style.display="none"};

onSnapshot(collection(db,"buses"),s=>{
 data=[];
 s.forEach(d=>data.push(d.data()));
 renderUpcoming();
});

loginBtn.onclick=()=>signInWithEmailAndPassword(auth,email.value,password.value);
logoutBtn.onclick=()=>signOut(auth);
onAuthStateChanged(auth,u=>{
 adminPanel.classList.toggle("hidden",!u);
});
</script>
</body>
</html>

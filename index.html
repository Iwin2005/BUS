<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracking</title>

<style>
:root{
  --bg1:#020617;
  --bg2:#020617;
  --card:#0f172a;
  --accent:#22d3ee;
  --accent2:#14b8a6;
  --text:#e5e7eb;
  --muted:#94a3b8;
}

body{
  margin:0;
  font-family:Segoe UI,Arial,sans-serif;
  background:radial-gradient(circle at top,#020617,#000);
  color:var(--text);
}

.container{
  max-width:1000px;
  margin:auto;
  padding:16px;
}

h2{
  text-align:center;
  margin-bottom:16px;
  color:#e2e8f0;
}

input,select,button{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  font-size:15px;
}

input,select{
  background:#020617;
  color:var(--text);
  border:1px solid #1e293b;
}

button{
  cursor:pointer;
  font-weight:600;
}

.sort-btn{
  background:#020617;
  border:1px solid var(--accent);
  color:var(--accent);
  margin-top:8px;
}

.track-btn{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#022c22;
  margin-top:10px;
}

.row{
  display:flex;
  gap:12px;
  margin-top:10px;
}
@media(max-width:700px){
  .row{flex-direction:column}
}

.card{
  background:linear-gradient(180deg,#020617,#020617);
  border:1px solid #1e293b;
  padding:14px;
  border-radius:14px;
  margin:14px 0;
  box-shadow:0 0 30px rgba(34,211,238,.12);
}

/* UPCOMING */
.upcoming-wrap{
  display:flex;
  gap:12px;
}
@media(max-width:700px){
  .upcoming-wrap{flex-direction:column}
}
.upcoming{
  flex:1;
  background:linear-gradient(180deg,#020617,#020617);
  border:1px solid #1e293b;
  border-radius:14px;
  padding:14px;
  text-align:center;
}
.up-title{
  font-size:17px;
  font-weight:700;
  color:var(--accent);
  margin-bottom:6px;
}
.countdown{
  font-size:22px;
  font-weight:800;
  color:#22c55e;
  margin-top:6px;
}

/* MAP */
.map-modal{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  z-index:9999;
}
.map-close{
  position:absolute;
  top:14px;
  right:14px;
  width:42px;
  height:42px;
  border-radius:50%;
  background:#22d3ee;
  border:none;
  font-size:22px;
}
#mapFrame{width:100%;height:100%;border:none}

.hidden{display:none}
</style>
</head>

<body>
<div class="container">

<h2>ğŸšŒ Smart Bus Tracking</h2>

<!-- UPCOMING -->
<div class="upcoming-wrap">
  <div class="upcoming" id="upDep"></div>
  <div class="upcoming" id="upArr"></div>
</div>

<input id="search" placeholder="Search city or travels">

<div class="row">
  <select id="operatorSelect"><option value="">All Operators</option></select>
  <select id="journeyFilter">
    <option value="both">Boarding & Dropping</option>
    <option value="boarding">Boarding</option>
    <option value="dropping">Dropping</option>
  </select>
</div>

<button id="sortBtn" class="sort-btn">â° Earliest First</button>

<div id="busList"></div>

</div>

<!-- MAP -->
<div class="map-modal" id="mapModal">
  <button class="map-close" onclick="closeMap()">âœ–</button>
  <iframe id="mapFrame"></iframe>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const app = initializeApp({
 apiKey:"AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",
 authDomain:"smart-bus-tracking-2ba21.firebaseapp.com",
 projectId:"smart-bus-tracking-2ba21"
});
const db = getFirestore(app);

let data=[],searchTxt="",operator="",journey="both",sortOrder="asc";
let depTimer=null,arrTimer=null;

/* helpers */
const toMin=t=>{
 let[p,m]=t.split(" ");
 let[h,mm]=p.split(":").map(Number);
 if(m==="PM"&&h!==12)h+=12;
 if(m==="AM"&&h===12)h=0;
 return h*60+mm;
}
const nextTime=time=>{
 const d=new Date();
 const m=toMin(time);
 d.setHours(Math.floor(m/60),m%60,0,0);
 if(d<Date.now()) d.setDate(d.getDate()+1);
 return d;
}

/* map */
window.openMap=u=>{
 mapFrame.src=u;
 mapModal.style.display="block";
}
window.closeMap=()=>{
 mapFrame.src="";
 mapModal.style.display="none";
}

/* upcoming */
function renderUpcoming(){
 clearInterval(depTimer); clearInterval(arrTimer);
 if(!data.length) return;

 let deps=[],arrs=[];
 data.forEach(b=>{
  const dep=b.route[0];
  const arr=b.route.at(-1);
  deps.push({bus:b,pt:dep,time:nextTime(dep.time)});
  arrs.push({bus:b,pt:arr,time:nextTime(arr.time)});
 });

 const depSoon=Math.min(...deps.map(x=>x.time));
 const arrSoon=Math.min(...arrs.map(x=>x.time));

 function tick(){
  const s=Math.max(0,Math.floor((depSoon-Date.now())/1000));
  const d=new Date(depSoon).toLocaleDateString();
  const b=deps.find(x=>x.time.getTime()===depSoon);
  upDep.innerHTML=`
   <div class="up-title">ğŸš¨ Upcoming Departure</div>
   ğŸ“… ${d}<br>
   ğŸšŒ ${b.bus.travel}<br>
   ğŸ“ ${b.pt.city} ${b.pt.time}
   <div class="countdown">${Math.floor(s/3600)}h ${Math.floor(s%3600/60)}m ${s%60}s</div>
  `;
 }
 tick(); depTimer=setInterval(tick,1000);

 function tick2(){
  const s=Math.max(0,Math.floor((arrSoon-Date.now())/1000));
  const d=new Date(arrSoon).toLocaleDateString();
  const b=arrs.find(x=>x.time.getTime()===arrSoon);
  upArr.innerHTML=`
   <div class="up-title">ğŸš Upcoming Arrival</div>
   ğŸ“… ${d}<br>
   ğŸšŒ ${b.bus.travel}<br>
   ğŸ ${b.pt.city} ${b.pt.time}
   <div class="countdown">${Math.floor(s/3600)}h ${Math.floor(s%3600/60)}m ${s%60}s</div>
  `;
 }
 tick2(); arrTimer=setInterval(tick2,1000);
}

/* list (FIXED LOGIC) */
function renderList(){
 busList.innerHTML="";
 let shown=0;

 data.forEach(bus=>{
  if(operator && bus.travel!==operator) return;

  let idx=-1;
  if(searchTxt){
   idx=bus.route.findIndex(r=>r.city.toLowerCase().includes(searchTxt));
   if(idx===-1) return;
  }

  if(journey==="boarding" && idx!==0) return;
  if(journey==="dropping" && idx<=0) return;

  shown++;
  const c=document.createElement("div");
  c.className="card";
  c.innerHTML=`
   <h3>${bus.travel}</h3>
   <b>${bus.route[0].city} (${bus.route[0].time}) â†’ ${bus.route.at(-1).city} (${bus.route.at(-1).time})</b>
   <hr>
   ${bus.route.map((r,i)=>`
    ${i===0?"ğŸŸ¢":i===bus.route.length-1?"ğŸ”µ":"â¡"} ${r.city} ${r.time}
   `).join("<br>")}
   <button class="track-btn" onclick="openMap('${bus.link}')">ğŸ“ View Live Location</button>
  `;
  busList.appendChild(c);
 });

 if(!shown){
  busList.innerHTML=`<div class="card">âŒ No buses found</div>`;
 }
}

/* operators */
function renderOperators(){
 operatorSelect.innerHTML='<option value="">All Operators</option>';
 [...new Set(data.map(b=>b.travel))].forEach(o=>{
  const op=document.createElement("option");
  op.value=o; op.textContent=o;
  operatorSelect.appendChild(op);
 });
}

/* events */
search.oninput=e=>{searchTxt=e.target.value.toLowerCase();renderList()};
operatorSelect.onchange=e=>{operator=e.target.value;renderList()};
journeyFilter.onchange=e=>{journey=e.target.value;renderList()};
sortBtn.onclick=()=>{
 sortOrder=sortOrder==="asc"?"desc":"asc";
 renderList();
};

/* firestore */
onSnapshot(collection(db,"buses"),snap=>{
 data=[];
 snap.forEach(d=>data.push(d.data()));
 renderOperators();
 renderUpcoming();
 renderList();
});
</script>
</body>
</html>
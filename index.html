<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BUS TRACKING</title>

<style>
:root { --primary:#2a9d8f; --secondary:#023047; --accent:#ffd60a; --bg:#f0f2f5; }
body{margin:0;font-family:'Segoe UI',sans-serif;background:var(--bg)}
.hidden{display:none!important}
header{background:#fff;padding:10px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
.btn-main{background:var(--primary);color:#fff;padding:10px 20px;border-radius:8px;border:none;cursor:pointer;font-weight:bold}
.container{max-width:1000px;margin:auto;padding:20px}
input,select{width:100%;padding:14px;margin:8px 0;border-radius:12px;border:1px solid #ddd}

.upcoming{display:flex;gap:15px;margin-bottom:25px}
.up-box{flex:1;background:#1b263b;color:#fff;border-radius:20px;padding:20px;text-align:center}
.count{font-size:26px;font-family:monospace}

.search-grid{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:12px;background:#fff;padding:15px;border-radius:15px}
.city-filter-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:20px 0}

.admin-panel{background:#fff;border:2px dashed var(--primary);padding:25px;border-radius:15px;margin-bottom:25px}

.card{background:#fff;padding:22px;border-radius:20px;margin:15px 0;box-shadow:0 6px 18px rgba(0,0,0,.06)}
.bus-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.travel-name{font-size:18px;font-weight:800;color:var(--secondary)}

.route-visual{display:flex;align-items:center;justify-content:space-between;margin:20px 0}
.point{text-align:center;flex:1}
.point b{display:block;font-size:16px}
.line{flex:1.5;height:2px;background:#ccc;margin:0 15px}

.stops-preview{background:#f7fafc;border-radius:12px;padding:12px;margin-bottom:15px}
.timeline-item{display:flex;align-items:center;font-size:13px;padding:5px 0;border-bottom:1px solid #eee}
.timeline-item:last-child{border-bottom:none}
.badge{font-size:9px;padding:3px 6px;border-radius:5px;margin-left:auto;font-weight:bold}
.boarding{background:#e9f5f3;color:#2a9d8f}
.dropping{background:#fef2f2;color:#e63946}

.map-modal{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none}
.map-close{position:absolute;top:15px;right:15px;background:yellow;border:none;width:45px;height:45px;border-radius:50%}
#mapFrame{width:100%;height:100%}
</style>
</head>

<body>

<header>
<h3>üöç BUS TRACKING</h3>
<div>
<span id="liveClock"></span>
<button id="logoutBtn" class="btn-main hidden">Logout</button>
</div>
</header>

<div class="container">

<!-- LOGIN -->
<div id="authWall">
<input id="uEmail" placeholder="Email">
<input id="uPass" type="password" placeholder="Password">
<button id="loginBtn" class="btn-main">Login</button>
</div>

<!-- MAIN -->
<div id="mainContent" class="hidden">

<div class="upcoming">
<div class="up-box"><div id="depCounter">00:00:00</div></div>
<div class="up-box"><div id="arrCounter">00:00:00</div></div>
</div>

<div id="adminPortal" class="admin-panel hidden">
<input id="travel" placeholder="Travels Name">
<select id="depCityAdmin"></select>
<input id="depTimeInput" placeholder="Departure Time">
<select id="destCityAdmin"></select>
<input id="destTimeInput" placeholder="Arrival Time">
<button onclick="addNewCity()" class="btn-main">‚ûï Add City</button>
<div id="dynamicStops"></div>
<button onclick="addStopField()" class="btn-main">‚ûï Add Stop</button>
<input id="trackLink" placeholder="Tracking Link">
<input type="hidden" id="editingBusId">
<button onclick="saveBusToFirebase()" class="btn-main">Save</button>
</div>

<div class="search-grid">
<input id="searchBox" placeholder="Search">
<select id="stopTypeFilter"><option>All</option><option>Boarding</option><option>Dropping</option></select>
<select id="sortOption"><option value="none">Sort</option></select>
<button onclick="clearAllSearch()" class="btn-main">Clear</button>
</div>

<div class="city-filter-row">
<select id="fromCity"></select>
<select id="toCity"></select>
</div>

<div id="welcomeArea">Search to see buses</div>
<div id="busDisplayArea" class="hidden"></div>

</div>
</div>

<div class="map-modal" id="mapModal">
<button class="map-close" onclick="closeMap()">‚úï</button>
<iframe id="mapFrame"></iframe>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig={apiKey:"AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",authDomain:"smart-bus-tracking-2ba21.firebaseapp.com",projectId:"smart-bus-tracking-2ba21"};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

const ADMIN_EMAIL="admin@wintracking.com";
let busDataArr=[],allCities=new Set();

setInterval(()=>liveClock.innerText=new Date().toLocaleTimeString(),1000);

onAuthStateChanged(auth,u=>{
 if(u){authWall.classList.add('hidden');mainContent.classList.remove('hidden');logoutBtn.classList.remove('hidden');}
 else{authWall.classList.remove('hidden');mainContent.classList.add('hidden')}
});

loginBtn.onclick=()=>signInWithEmailAndPassword(auth,uEmail.value,uPass.value);
logoutBtn.onclick=()=>signOut(auth);

onSnapshot(collection(db,"buses"),snap=>{
 busDataArr=snap.docs.map(d=>({id:d.id,...d.data()}));
 allCities.clear();
 busDataArr.forEach(b=>{
  allCities.add(b.depCity);
  allCities.add(b.destCity);
  b.route?.forEach(r=>allCities.add(r.city));
 });
 rebuildUI();
});

function rebuildUI(){
 const list=document.getElementById("busDisplayArea");
 list.innerHTML="";
 list.classList.remove("hidden");

 busDataArr.forEach(b=>{
  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`
  <div class="bus-header">
   <div class="travel-name">${b.travel}</div>
  </div>

  <div class="route-visual">
   <div class="point"><b>${b.depCity}</b><span>${b.depTime}</span></div>
   <div class="line"></div>
   <div class="point"><b>${b.destCity}</b><span>${b.destTime}</span></div>
  </div>

  <div class="stops-preview">
   ${(b.route||[]).map(r=>`
    <div class="timeline-item">
     <b>${r.city}</b>
     <span>${r.time}</span>
     <span class="badge ${r.type.toLowerCase()}">${r.type}</span>
    </div>`).join("")}
  </div>

  <button class="btn-main" onclick="openMap('${b.link}')">Track</button>
  `;
  list.appendChild(card);
 });
}

function addNewCity(){
 const c=prompt("City Name");
 if(c)allCities.add(c.trim());
}

function addStopField(){}
function saveBusToFirebase(){}
function clearAllSearch(){}

window.openMap=u=>{mapFrame.src=u;mapModal.style.display="block"}
window.closeMap=()=>{mapFrame.src="";mapModal.style.display="none"}
</script>

</body>
</html>
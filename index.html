<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracking</title>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(to right,#fff3b0,#ffd60a);
}
.container{max-width:1000px;margin:auto;padding:15px}
h2{text-align:center;color:#3a2f00}

input,select,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:8px;
  border:none;
  font-size:16px;
}
button{cursor:pointer;font-weight:bold}

.track-btn{background:#2a9d8f;color:#fff}
.sort-btn{background:#023047;color:#fff}

.card{
  background:#fff8dc;
  padding:15px;
  border-radius:10px;
  margin:12px 0;
  box-shadow:0 0 8px rgba(0,0,0,.2)
}

.row{display:flex;gap:12px}
@media(max-width:700px){.row{flex-direction:column}}

.upcoming-box{
  background:#fff;
  border-radius:10px;
  padding:15px;
  flex:1;
  box-shadow:0 0 8px rgba(0,0,0,.2)
}
.upcoming-title{
  text-align:center;
  font-weight:bold;
  font-size:18px;
  margin-bottom:6px
}
.date-line{
  text-align:center;
  font-size:14px;
  margin-bottom:10px
}
.arrival-highlight{
  background:#e0f7fa;
  padding:6px;
  border-radius:6px;
  font-weight:bold
}

/* MAP */
.map-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  z-index:9999;
}
.map-close{
  position:absolute;
  top:10px;
  right:10px;
  background:#ffd60a;
  border:none;
  font-size:22px;
  width:40px;
  height:40px;
  border-radius:50%;
}
#mapFrame{width:100%;height:100%;border:none}
</style>
</head>

<body>
<div class="container">

<h2>ğŸšŒ Smart Bus Tracking</h2>

<!-- UPCOMING BOXES -->
<div class="row">
  <div class="upcoming-box" id="upcomingDeparture"></div>
  <div class="upcoming-box" id="upcomingArrival"></div>
</div>

<input id="search" placeholder="Search city or travels">

<div class="row">
<select id="operatorSelect">
<option value="">All Operators</option>
</select>

<select id="journeyFilter">
<option value="both">Boarding & Dropping</option>
<option value="boarding">Boarding</option>
<option value="dropping">Dropping</option>
</select>
</div>

<button id="sortBtn" class="sort-btn">â° Earliest First</button>

<div id="busList"></div>
</div>

<!-- MAP -->
<div id="mapModal" class="map-modal">
<button class="map-close" onclick="closeMap()">âœ–</button>
<iframe id="mapFrame"></iframe>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const app = initializeApp({
 apiKey:"AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",
 authDomain:"smart-bus-tracking-2ba21.firebaseapp.com",
 projectId:"smart-bus-tracking-2ba21"
});
const db = getFirestore(app);

let data=[],searchTxt="",operator="",journey="both",sortOrder="asc";
let depTimer=null,arrTimer=null;

search.oninput=e=>{searchTxt=e.target.value.toLowerCase();renderAll()};
operatorSelect.onchange=e=>{operator=e.target.value;renderAll()};
journeyFilter.onchange=e=>{journey=e.target.value;renderAll()};
sortBtn.onclick=()=>{
 sortOrder=sortOrder==="asc"?"desc":"asc";
 sortBtn.innerText=sortOrder==="asc"?"â° Earliest First":"â° Latest First";
 renderList();
};

function toMin(t){
 let[p,m]=t.split(" ");
 let[h,mm]=p.split(":").map(Number);
 if(m==="PM"&&h!==12)h+=12;
 if(m==="AM"&&h===12)h=0;
 return h*60+mm;
}
function dateLabel(d){
 const today=new Date();
 const diff=Math.floor((d-today)/86400000);
 const label=diff===0?"Today":diff===1?"Tomorrow":d.toDateString();
 return label+" ("+d.toDateString()+")";
}
function nextTime(time){
 const mins=toMin(time);
 let d=new Date();
 d.setHours(Math.floor(mins/60),mins%60,0,0);
 if(d.getTime()<Date.now()) d.setDate(d.getDate()+1);
 return d;
}

window.openMap=url=>{
 mapFrame.src=url;
 mapModal.style.display="block";
};
window.closeMap=()=>{
 mapFrame.src="";
 mapModal.style.display="none";
};

function filterData(){
 return data.filter(b=>{
  if(operator && b.travel!==operator) return false;
  if(!searchTxt) return true;
  if(b.travel.toLowerCase().includes(searchTxt)) return true;
  return b.route.some(r=>r.city.toLowerCase().includes(searchTxt));
 });
}

function renderUpcoming(){
 clearInterval(depTimer);clearInterval(arrTimer);
 const filtered=filterData();

 /* DEPARTURE */
 let deps=[];
 filtered.forEach(b=>{
  const p=b.route.find(r=>r.type==="boarding");
  if(!p) return;
  const d=nextTime(p.time);
  deps.push({bus:b,point:p,time:d});
 });

 if(!deps.length){
  upcomingDeparture.innerHTML="<div class='upcoming-title'>ğŸš¨ UPCOMING DEPARTURE</div>No upcoming departure";
 }else{
  const soon=Math.min(...deps.map(x=>x.time.getTime()));
  const list=deps.filter(x=>x.time.getTime()===soon);
  function tick(){
   const diff=soon-Date.now();
   if(diff<=0){renderUpcoming();return;}
   const s=Math.floor(diff/1000);
   upcomingDeparture.innerHTML=`
    <div class="upcoming-title">ğŸš¨ UPCOMING DEPARTURE</div>
    <div class="date-line">ğŸ“… ${dateLabel(new Date(soon))}</div>
    ${list.map(o=>`
      ğŸšŒ ${o.bus.travel}<br>
      ğŸ“ ${o.point.city} â†’ ${o.bus.route.at(-1).city}<br>
      â° ${o.point.time}<br><br>
    `).join("")}
    â³ Departs in ${Math.floor(s/3600)}h ${Math.floor(s%3600/60)}m ${s%60}s
   `;
  }
  tick();depTimer=setInterval(tick,1000);
 }

 /* ARRIVAL */
 let arrs=[];
 filtered.forEach(b=>{
  const p=[...b.route].reverse().find(r=>r.type==="dropping");
  if(!p) return;
  const d=nextTime(p.time);
  arrs.push({bus:b,point:p,time:d});
 });

 if(!arrs.length){
  upcomingArrival.innerHTML="<div class='upcoming-title'>ğŸš UPCOMING ARRIVAL</div>No upcoming arrival";
 }else{
  const soon=Math.min(...arrs.map(x=>x.time.getTime()));
  const list=arrs.filter(x=>x.time.getTime()===soon);
  function tickA(){
   const diff=soon-Date.now();
   if(diff<=0){renderUpcoming();return;}
   const s=Math.floor(diff/1000);
   upcomingArrival.innerHTML=`
    <div class="upcoming-title">ğŸš UPCOMING ARRIVAL</div>
    <div class="date-line">ğŸ“… ${dateLabel(new Date(soon))}</div>
    ${list.map(o=>`
      ğŸšŒ ${o.bus.travel}<br>
      <div class="arrival-highlight">ğŸ ${o.point.city} â€“ ${o.point.time}</div><br>
    `).join("")}
    â³ Arrives in ${Math.floor(s/3600)}h ${Math.floor(s%3600/60)}m ${s%60}s
   `;
  }
  tickA();arrTimer=setInterval(tickA,1000);
 }
}

function renderList(){
 busList.innerHTML="";
 let shown=0;
 const list=filterData().sort((a,b)=>{
  return sortOrder==="asc"
   ? toMin(a.route[0].time)-toMin(b.route[0].time)
   : toMin(b.route[0].time)-toMin(a.route[0].time);
 });

 list.forEach(bus=>{
  const matchCity=bus.route.find(r=>r.city.toLowerCase().includes(searchTxt));
  if(matchCity){
    if(journey==="boarding" && matchCity.type!=="boarding") return;
    if(journey==="dropping" && matchCity.type!=="dropping") return;
  }
  shown++;
  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`
   <h3>ğŸšŒ ${bus.travel}</h3>
   ${bus.route.map(r=>`
     ${r.type==="boarding"?"ğŸŸ¢":r.type==="dropping"?"ğŸ”µ":"â¡"}
     ${r.city} ${r.time}
   `).join("<br>")}
   <br><br>
   <button class="track-btn" onclick="openMap('${bus.link}')">Track</button>
  `;
  busList.appendChild(card);
 });
 if(!shown) busList.innerHTML="<div class='card'>âŒ No buses found</div>";
}

function renderOperators(){
 operatorSelect.innerHTML='<option value="">All Operators</option>';
 [...new Set(data.map(b=>b.travel))].forEach(o=>{
  const op=document.createElement("option");
  op.value=o;op.textContent=o;
  operatorSelect.appendChild(op);
 });
}

function renderAll(){
 renderUpcoming();
 renderList();
}

onSnapshot(collection(db,"buses"),snap=>{
 data=[];
 snap.forEach(d=>data.push(d.data()));
 renderOperators();
 renderAll();
});
</script>
</body>
</html>

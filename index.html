<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIN BUS TRACKING PRO</title>
    <style>
        :root { --primary: #2a9d8f; --secondary: #023047; --accent: #ffd60a; --bg: #f0f2f5; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: #333; }
        header { background: #fff; padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        #liveClock { font-family: 'Courier New', monospace; font-weight: bold; color: var(--secondary); background: #eee; padding: 5px 12px; border-radius: 5px; }
        .btn-main { background: var(--primary); color: #fff; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .container { max-width: 1000px; margin: auto; padding: 20px; }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; outline: none; }

        /* Dashboard */
        .upcoming { display: flex; gap: 15px; margin-bottom: 25px; }
        .up-box { flex: 1; background: #1b263b; color: #fff; border-radius: 20px; padding: 20px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .count { font-size: 22px; font-weight: bold; font-family: monospace; color: var(--accent); }

        /* Admin Portal */
        .admin-panel { background: #fff; border: 2px solid var(--primary); padding: 20px; border-radius: 15px; margin-bottom: 25px; }
        .stop-entry { display: flex; gap: 8px; align-items: center; background: #f4f4f4; padding: 8px; border-radius: 8px; margin-bottom: 5px; }

        /* Cards */
        .card { background: #fff; padding: 20px; border-radius: 15px; margin: 15px 0; border-left: 6px solid var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .timeline-item { display: flex; align-items: center; padding: 6px 0; font-size: 13px; border-bottom: 1px solid #eee; }
        .badge { font-size: 9px; padding: 3px 6px; border-radius: 4px; margin-left: auto; font-weight: bold; text-transform: uppercase; }
        .boarding { background: #e9f5f3; color: #2a9d8f; }
        .dropping { background: #fef2f2; color: #e63946; }

        .map-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; z-index: 9999; }
        #mapFrame { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>

<header>
    <h3 style="margin:0; color:var(--secondary)">üöç WIN BUS TRACKING</h3>
    <div class="header-right">
        <div id="liveClock">00:00:00</div>
        <button id="logoutBtn" class="btn-main hidden" style="background:#e63946;">Log Out</button>
    </div>
</header>

<div class="container">
    <div id="authWall">
        <div style="text-align:center; background:white; padding:40px; border-radius:20px; max-width:400px; margin:80px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
            <h2>Admin Login</h2>
            <input type="email" id="uEmail" placeholder="Email">
            <input type="password" id="uPass" placeholder="Password">
            <button class="btn-main" style="width:100%; margin-top:10px;" id="loginBtn">Login</button>
        </div>
    </div>

    <div id="mainContent" class="hidden">
        <div class="upcoming">
            <div class="up-box">
                <div style="font-size:11px; opacity:0.7">NEXT DEPARTURE</div>
                <b id="depBusName">---</b>
                <div class="count" id="depCounter">00:00:00</div>
            </div>
            <div class="up-box">
                <div style="font-size:11px; opacity:0.7">NEXT ARRIVAL</div>
                <b id="arrBusName">---</b>
                <div class="count" id="arrCounter">00:00:00</div>
            </div>
        </div>

        <div id="adminPortal" class="admin-panel hidden">
            <h3>üõ† Management Portal</h3>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px; background: #eee; padding: 10px; border-radius: 8px;">
                <input id="newCityName" placeholder="Type new city name..." style="margin:0">
                <button onclick="addNewCity()" class="btn-main" style="white-space:nowrap">+ Add City to List</button>
            </div>

            <input id="travel" placeholder="Bus/Travels Name">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <select id="depCityAdmin"><option value="">Departure City</option></select>
                <input id="depTimeInput" placeholder="Time (09:00 AM)">
                <select id="destCityAdmin"><option value="">Destination City</option></select>
                <input id="destTimeInput" placeholder="Time (05:00 PM)">
            </div>
            
            <div id="dynamicStops" style="margin-top:10px;"></div>
            <button onclick="addStopField()" class="btn-main" style="background:#666; width:100%; margin-bottom:10px;">+ Add Intermediate Stop</button>
            
            <input id="trackLink" placeholder="Tracking Link (URL)">
            <input type="hidden" id="editingBusId">
            <button onclick="saveBusToFirebase()" class="btn-main" style="width:100%">üíæ Save Record</button>
        </div>

        <div style="background:#fff; padding:15px; border-radius:15px; margin-bottom:15px;">
            <input id="searchBox" placeholder="üîç Search bus name...">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="fromCity"><option value="">From (Boarding)</option></select>
                <select id="toCity"><option value="">To (Dropping)</option></select>
            </div>
        </div>

        <div id="busDisplayArea"></div>
    </div>
</div>

<div class="map-modal" id="mapModal">
    <button style="position:absolute; top:20px; right:20px; z-index:100" onclick="closeMap()">Close ‚úï</button>
    <iframe id="mapFrame"></iframe>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = { apiKey: "AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0", authDomain: "smart-bus-tracking-2ba21.firebaseapp.com", projectId: "smart-bus-tracking-2ba21" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const ADMIN_EMAIL = "admin@wintracking.com"; 
let busDataArr = [];
let masterCities = new Set(["CHENNAI", "MADURAI", "COIMBATORE", "TRICHY", "SALEM", "TIRUNELVELI", "ERODE", "VELLORE"]);

setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString(); }, 1000);

onAuthStateChanged(auth, user => {
    if (user) {
        document.getElementById('mainContent').classList.remove('hidden');
        document.getElementById('authWall').classList.add('hidden');
        document.getElementById('logoutBtn').classList.remove('hidden');
        if(user.email === ADMIN_EMAIL) document.getElementById('adminPortal').classList.remove('hidden');
        rebuildUI();
    } else {
        document.getElementById('mainContent').classList.add('hidden');
        document.getElementById('authWall').classList.remove('hidden');
    }
});

/* --- CITY MANAGEMENT --- */
window.addNewCity = () => {
    const name = document.getElementById('newCityName').value.trim().toUpperCase();
    if(name) {
        masterCities.add(name);
        document.getElementById('newCityName').value = "";
        refreshCityDropdowns();
        alert(name + " added to local list!");
    }
};

function refreshCityDropdowns() {
    const sorted = Array.from(masterCities).sort();
    const options = sorted.map(c => `<option value="${c}">${c}</option>`).join('');
    ['depCityAdmin', 'destCityAdmin', 'fromCity', 'toCity'].forEach(id => {
        const el = document.getElementById(id);
        const placeholder = el.options[0].text;
        el.innerHTML = `<option value="">${placeholder}</option>` + options;
    });
}

/* --- SEARCH LOGIC (FIXED) --- */
function rebuildUI() {
    const term = searchBox.value.toLowerCase();
    const fromVal = fromCity.value;
    const toVal = toCity.value;
    const listArea = document.getElementById('busDisplayArea');
    const isAdmin = auth.currentUser?.email === ADMIN_EMAIL;

    let filtered = busDataArr.filter(b => {
        const busNameMatch = b.travel.toLowerCase().includes(term);
        
        // Logical Route Check
        const boardingPoints = [b.depCity, ...(b.route || []).filter(r => r.type === "Boarding").map(r => r.city)];
        const droppingPoints = [b.destCity, ...(b.route || []).filter(r => r.type === "Dropping").map(r => r.city)];

        const fromMatch = !fromVal || boardingPoints.includes(fromVal);
        const toMatch = !toVal || droppingPoints.includes(toVal);

        return busNameMatch && fromMatch && toMatch;
    });

    listArea.innerHTML = "";
    filtered.forEach(b => {
        const card = document.createElement("div"); card.className = "card";
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between">
                <h3 style="margin:0">üöå ${b.travel}</h3>
                ${isAdmin ? `<div><button onclick="triggerEdit('${b.id}')">Edit</button> <button onclick="triggerDelete('${b.id}')">Delete</button></div>` : ''}
            </div>
            <p><b>${b.depCity} (${b.depTime})</b> ‚ûî <b>${b.destCity} (${b.destTime})</b></p>
            <div style="margin-bottom:10px">
                ${(b.route || []).map(r => `<div class="timeline-item">üìç ${r.city} - ${r.time} <span class="badge ${r.type.toLowerCase()}">${r.type}</span></div>`).join('')}
            </div>
            <button class="btn-main" style="width:100%" onclick="openMap('${b.link}')">TRACK LIVE</button>`;
        listArea.appendChild(card);
    });
}

/* --- ADMIN ACTIONS --- */
window.addStopField = (city = "", time = "", type = "Boarding") => {
    const div = document.createElement("div"); div.className = "stop-entry";
    const cityOptions = Array.from(masterCities).sort().map(c => `<option value="${c}" ${c===city?'selected':''}>${c}</option>`).join('');
    div.innerHTML = `
        <select class="s-city">${cityOptions}</select>
        <input class="s-time" value="${time}" placeholder="Time">
        <select class="s-type">
            <option value="Boarding" ${type==='Boarding'?'selected':''}>Boarding</option>
            <option value="Dropping" ${type==='Dropping'?'selected':''}>Dropping</option>
        </select>
        <button onclick="this.parentElement.remove()" style="color:red">X</button>`;
    document.getElementById('dynamicStops').appendChild(div);
};

window.saveBusToFirebase = async () => {
    const id = document.getElementById('editingBusId').value;
    const route = [];
    document.querySelectorAll('.stop-entry').forEach(row => {
        route.push({ city: row.querySelector('.s-city').value, time: row.querySelector('.s-time').value, type: row.querySelector('.s-type').value });
    });

    const data = {
        travel: travel.value, depCity: depCityAdmin.value, depTime: depTimeInput.value,
        destCity: destCityAdmin.value, destTime: destTimeInput.value,
        link: trackLink.value, route: route
    };

    id ? await updateDoc(doc(db, "buses", id), data) : await addDoc(collection(db, "buses"), data);
    location.reload(); 
};

window.triggerEdit = (id) => {
    const b = busDataArr.find(x => x.id === id);
    document.getElementById('editingBusId').value = id;
    document.getElementById('travel').value = b.travel;
    document.getElementById('depCityAdmin').value = b.depCity;
    document.getElementById('depTimeInput').value = b.depTime;
    document.getElementById('destCityAdmin').value = b.destCity;
    document.getElementById('destTimeInput').value = b.destTime;
    document.getElementById('trackLink').value = b.link;
    document.getElementById('dynamicStops').innerHTML = "";
    b.route?.forEach(r => addStopField(r.city, r.time, r.type));
};

window.triggerDelete = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "buses", id)); };

onSnapshot(collection(db, "buses"), snap => {
    busDataArr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    // Auto-discover cities from database
    busDataArr.forEach(b => {
        masterCities.add(b.depCity.toUpperCase());
        masterCities.add(b.destCity.toUpperCase());
        b.route?.forEach(r => masterCities.add(r.city.toUpperCase()));
    });
    refreshCityDropdowns();
    rebuildUI();
});

document.getElementById('loginBtn').onclick = () => signInWithEmailAndPassword(auth, uEmail.value, uPass.value);
document.getElementById('logoutBtn').onclick = () => signOut(auth);
searchBox.oninput = rebuildUI; fromCity.onchange = rebuildUI; toCity.onchange = rebuildUI;
window.openMap = (url) => { document.getElementById('mapFrame').src = url; document.getElementById('mapModal').style.display = 'block'; };
window.closeMap = () => { document.getElementById('mapModal').style.display = 'none'; };
</script>
</body>
</html>

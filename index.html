<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BUS TRACKING</title>

<style>
:root {
    --primary: #2a9d8f;
    --secondary: #023047;
    --neon-green: #39ff14;
    --neon-blue: #00f3ff;
    --accent: #ffd60a;
    --bg: #0b132b; /* Darker background for neon effect */
    --card-bg: #ffffff;
}

/* Animations */
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes neonPulse {
    0% { box-shadow: 0 0 5px var(--neon-blue); }
    50% { box-shadow: 0 0 20px var(--neon-blue); }
    100% { box-shadow: 0 0 5px var(--neon-blue); }
}

body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: #e0e1dd;
    transition: background 0.5s;
}

.container { max-width: 1000px; margin: auto; padding: 20px; }
h2 { text-align: center; color: var(--neon-blue); margin-bottom: 25px; letter-spacing: 3px; text-shadow: 0 0 10px var(--neon-blue); }

/* Welcome Area */
#welcomeArea {
    text-align: center;
    padding: 60px 20px;
    animation: fadeInUp 1s ease;
}
#welcomeArea h1 { color: #fff; text-shadow: 0 0 15px var(--neon-blue); }

/* Neon Dashboard Boxes */
.upcoming { display: flex; gap: 15px; margin-bottom: 30px; }
.up-box {
    flex: 1;
    background: #1c2541;
    color: #fff;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    border: 1px solid var(--neon-blue);
    box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
    transition: 0.3s;
}
.up-box:hover { transform: translateY(-5px); box-shadow: 0 0 25px var(--neon-blue); }

.count { font-size: 24px; font-weight: bold; color: var(--neon-green); text-shadow: 0 0 8px var(--neon-green); margin-top: 10px; display: block; }

/* Search Controls */
.search-grid, .city-filter-row {
    background: rgba(28, 37, 65, 0.8);
    padding: 15px;
    border-radius: 15px;
    margin-bottom: 10px;
    backdrop-filter: blur(10px);
}

input, select {
    background: #0b132b;
    color: #fff;
    border: 1px solid #3a506b;
    padding: 12px;
    border-radius: 8px;
    width: 100%;
    box-sizing: border-box;
}
input:focus { border-color: var(--neon-blue); outline: none; box-shadow: 0 0 10px var(--neon-blue); }

/* Bus Cards */
.card {
    background: #fff;
    color: #333;
    padding: 20px;
    border-radius: 15px;
    margin: 15px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    border-left: 5px solid var(--neon-blue);
    animation: fadeInUp 0.5s ease forwards;
}

.track-btn {
    background: var(--secondary);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    width: 100%;
    cursor: pointer;
    font-weight: bold;
    animation: neonPulse 2s infinite;
}

.delete-btn { background: #ff4d4d; color: white; margin-top: 10px; cursor: pointer; }
.hidden { display: none !important; }

/* Modal */
.map-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; z-index: 9999; }
.map-close { position: absolute; top: 15px; right: 15px; background: var(--accent); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: none; }
#mapFrame { width: 100%; height: 100%; border: none; }

@media(max-width: 768px) { .upcoming { flex-direction: column; } }
</style>
</head>

<body>
<div class="container">

<h2>üöç BUS TRACKING</h2>

<div class="upcoming">
  <div class="up-box">
      <div style="font-size:11px; color:#5bc0be">NEXT DEPARTURE</div>
      <div id="depInfo">Ready...</div>
      <span class="count" id="depCount">00:00:00</span>
  </div>
  <div class="up-box">
      <div style="font-size:11px; color:#5bc0be">NEXT ARRIVAL</div>
      <div id="arrInfo">Ready...</div>
      <span class="count" id="arrCount">00:00:00</span>
  </div>
</div>

<div class="search-grid" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px;">
    <input id="search" placeholder="üîç Search bus, city, or via routes...">
    <select id="stopType">
        <option value="All">All Stops</option>
        <option value="Boarding">Boarding Points</option>
        <option value="Dropping">Dropping Points</option>
    </select>
    <select id="operatorFilter"><option value="All">All Operators</option></select>
</div>
<div class="city-filter-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
    <select id="fromCity"><option value="">Select Boarding City</option></select>
    <select id="toCity"><option value="">Select Destination</option></select>
</div>

<div id="welcomeArea">
    <h1>üëã Ready to Track?</h1>
    <p>Search by operator or city to find your bus live results.</p>
</div>

<div id="busList" class="hidden"></div>

<hr style="margin: 40px 0; border: 0; border-top: 1px solid #3a506b;">

<div id="loginBox" class="card" style="background: #1c2541; border: 1px solid var(--neon-blue);">
  <h3 style="color: white;">üîê Admin Access</h3>
  <input id="email" type="email" autocomplete="username" placeholder="Admin Email">
  <input id="pass" type="password" autocomplete="current-password" placeholder="Password">
  <button id="loginBtn" style="background:var(--neon-blue); color:var(--secondary);">Login</button>
</div>

<div id="adminPanel" class="hidden card" style="background: #fdfdfd;">
  <h3 id="adminTitle">üõ† Bus Management</h3>
  <input id="travel" placeholder="Travels Name" style="background:#fff; color:#333; border: 1px solid #ddd;">
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
    <input id="depCity" placeholder="Source City" style="background:#fff; color:#333; border: 1px solid #ddd;">
    <input id="depTime" placeholder="05:50 PM" style="background:#fff; color:#333; border: 1px solid #ddd;">
    <input id="destCity" placeholder="Destination City" style="background:#fff; color:#333; border: 1px solid #ddd;">
    <input id="destTime" placeholder="06:00 AM" style="background:#fff; color:#333; border: 1px solid #ddd;">
  </div>
  <div id="routes"></div>
  <button onclick="addRouteUI()" style="background:#eee; color:#333; margin-top:5px">‚ûï Add Via Stop</button>
  <input id="link" placeholder="Tracking Link" style="background:#fff; color:#333; border: 1px solid #ddd;">
  
  <input type="hidden" id="editingBusId">
  <button onclick="saveBus()" style="background:var(--primary); color:white; margin-top:10px">üíæ Save Bus</button>
  <button id="delBtn" onclick="deleteBus()" class="delete-btn hidden">üóë Delete Bus Permanently</button>
  <button onclick="logout()" style="background:#666; color:white; margin-top:20px">Logout</button>
</div>

</div>

<div class="map-modal" id="mapModal">
  <button class="map-close" onclick="closeMap()">‚úï</button>
  <iframe id="mapFrame"></iframe>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = { 
    apiKey: "AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0", 
    authDomain: "smart-bus-tracking-2ba21.firebaseapp.com", 
    projectId: "smart-bus-tracking-2ba21" 
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let data = [];

/* --- TIME ENGINE --- */
function getNextOccurrence(timeStr) {
    if (!timeStr || !timeStr.includes(" ")) return null;
    try {
        const now = new Date();
        let [time, modifier] = timeStr.split(" ");
        let [hours, minutes] = time.split(":").map(Number);
        if (modifier.toUpperCase() === "PM" && hours !== 12) hours += 12;
        if (modifier.toUpperCase() === "AM" && hours === 12) hours = 0;
        let target = new Date();
        target.setHours(hours, minutes, 0, 0);
        if (target < now) target.setDate(target.getDate() + 1);
        return target;
    } catch (e) { return null; }
}

function formatCountdown(ms) {
    if (ms < 0) return "00h 00m 00s";
    const totalSeconds = Math.floor(ms / 1000);
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return `${h.toString().padStart(2,'0')}h ${m.toString().padStart(2,'0')}m ${s.toString().padStart(2,'0')}s`;
}

function updateDashboard() {
    if (!data.length) return;
    let depList = data.map(b => ({ bus: b, target: getNextOccurrence(b.depTime) })).filter(x => x.target).sort((a,b) => a.target - b.target);
    let arrList = data.map(b => ({ bus: b, target: getNextOccurrence(b.destTime) })).filter(x => x.target).sort((a,b) => a.target - b.target);
    if (!depList.length) return;
    const nextD = depList[0], nextA = arrList[0];
    document.getElementById('depInfo').innerHTML = `<div style="color:var(--neon-blue); font-weight:bold">${nextD.bus.travel}</div><div style="font-size:12px">${nextD.bus.depCity} (${nextD.bus.depTime})</div>`;
    document.getElementById('arrInfo').innerHTML = `<div style="color:var(--neon-blue); font-weight:bold">${nextA.bus.travel}</div><div style="font-size:12px">${nextA.bus.destCity} (${nextA.bus.destTime})</div>`;
    if (window.timerInterval) clearInterval(window.timerInterval);
    window.timerInterval = setInterval(() => {
        document.getElementById('depCount').innerText = formatCountdown(nextD.target - new Date());
        document.getElementById('arrCount').innerText = formatCountdown(nextA.target - new Date());
    }, 1000);
}

/* --- FILTER LOGIC --- */
function updateDropdowns() {
    const ops = new Set(), cities = new Set();
    data.forEach(b => {
        ops.add(b.travel);
        cities.add(b.depCity); cities.add(b.destCity);
        if(b.route) b.route.forEach(r => cities.add(r.city));
    });
    const opFilter = document.getElementById('operatorFilter');
    opFilter.innerHTML = '<option value="All">All Operators</option>';
    Array.from(ops).sort().forEach(o => opFilter.innerHTML += `<option value="${o}">${o}</option>`);
    const fromSelect = document.getElementById('fromCity');
    fromSelect.innerHTML = '<option value="">Select Boarding City</option>';
    Array.from(cities).sort().forEach(c => fromSelect.innerHTML += `<option value="${c}">${c}</option>`);
}

document.getElementById('fromCity').onchange = () => {
    const from = document.getElementById('fromCity').value;
    const toSelect = document.getElementById('toCity');
    const reachable = new Set();
    data.forEach(b => {
        const stops = [b.depCity, ...(b.route?.map(r => r.city) || []), b.destCity];
        const idx = stops.indexOf(from);
        if(idx !== -1) stops.slice(idx + 1).forEach(s => reachable.add(s));
    });
    toSelect.innerHTML = '<option value="">Select Destination</option>';
    Array.from(reachable).sort().forEach(s => toSelect.innerHTML += `<option value="${s}">${s}</option>`);
    renderList();
};

function renderList() {
    const term = document.getElementById('search').value.toLowerCase();
    const op = document.getElementById('operatorFilter').value;
    const from = document.getElementById('fromCity').value;
    const to = document.getElementById('toCity').value;
    const busListDiv = document.getElementById('busList');
    const welcome = document.getElementById('welcomeArea');

    if (!term && !from && !to && op === "All") {
        welcome.classList.remove('hidden');
        busListDiv.classList.add('hidden');
        return;
    }

    const filtered = data.filter(b => {
        const allCities = [b.depCity, ...(b.route?.map(r => r.city) || []), b.destCity].join(' ').toLowerCase();
        const textMatch = b.travel.toLowerCase().includes(term) || allCities.includes(term);
        const opMatch = (op === "All" || b.travel === op);
        let routeMatch = true;
        if(from || to) {
            const stops = [b.depCity, ...(b.route?.map(r => r.city) || []), b.destCity];
            if(from && to) {
                const fi = stops.indexOf(from), ti = stops.indexOf(to);
                routeMatch = (fi !== -1 && ti !== -1 && fi < ti);
            } else if(from) routeMatch = stops.includes(from);
        }
        return textMatch && opMatch && routeMatch;
    });

    welcome.classList.add('hidden');
    busListDiv.classList.remove('hidden');
    busListDiv.innerHTML = filtered.length ? "" : "<p style='text-align:center; padding:40px;'>No matching buses found.</p>";

    filtered.forEach((b, idx) => {
        const c = document.createElement("div");
        c.className = "card";
        c.style.animationDelay = (idx * 0.1) + "s";
        c.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                    <h3 style="margin:0; color:var(--secondary)">üöå ${b.travel}</h3>
                    <div style="color:var(--primary); font-weight:bold; font-size:14px; margin-top:5px">
                        ${b.depCity} (${b.depTime}) ‚ûî ${b.destCity} (${b.destTime})
                    </div>
                </div>
                ${auth.currentUser ? `<button class="edit-btn" style="background:var(--accent); color:#333; padding:5px 10px; border-radius:5px" onclick="editBus('${b.id}')">Edit</button>` : ''}
            </div>
            <button class="track-btn" onclick="window.openMap('${b.link}')">üìç View Live Location</button>
        `;
        busListDiv.appendChild(c);
    });
}

/* --- ADMIN --- */
document.getElementById('loginBtn').onclick = () => {
    signInWithEmailAndPassword(auth, email.value, pass.value).catch(err => alert(err.message));
};
window.logout = () => signOut(auth);

onAuthStateChanged(auth, u => {
    document.getElementById('loginBox').classList.toggle('hidden', !!u);
    document.getElementById('adminPanel').classList.toggle('hidden', !u);
    renderList();
});

window.addRouteUI = (c = "", t = "", ty = "Boarding") => {
    const d = document.createElement("div");
    d.className = "row stop-row"; d.style.display="flex"; d.style.gap="5px";
    d.innerHTML = `<input class="c-city" placeholder="City" value="${c}" style="flex:2; background:#fff; color:#333"><input class="c-time" placeholder="Time" value="${t}" style="flex:1; background:#fff; color:#333"><select class="c-type" style="flex:1; background:#fff; color:#333"><option value="Boarding" ${ty==='Boarding'?'selected':''}>Boarding</option><option value="Dropping" ${ty==='Dropping'?'selected':''}>Dropping</option></select><button onclick="this.parentElement.remove()" style="background:red; color:white; width:40px">X</button>`;
    document.getElementById('routes').appendChild(d);
};

window.saveBus = async () => {
    const id = document.getElementById('editingBusId').value, via = [];
    document.querySelectorAll(".stop-row").forEach(r => via.push({ city: r.querySelector(".c-city").value, time: r.querySelector(".c-time").value, type: r.querySelector(".c-type").value }));
    const obj = { travel: travel.value, depCity: depCity.value, depTime: depTime.value, destCity: destCity.value, destTime: destTime.value, link: link.value, route: via };
    try {
        id ? await updateDoc(doc(db, "buses", id), obj) : await addDoc(collection(db, "buses"), obj);
        alert("Success!"); location.reload();
    } catch(e) { alert(e.message); }
};

window.deleteBus = async () => {
    const id = document.getElementById('editingBusId').value;
    if (confirm("Delete this bus record forever?") && id) {
        await deleteDoc(doc(db, "buses", id));
        alert("Deleted."); location.reload();
    }
};

window.editBus = (id) => {
    const b = data.find(x => x.id === id);
    document.getElementById('editingBusId').value = id;
    travel.value = b.travel; depCity.value = b.depCity; depTime.value = b.depTime; destCity.value = b.destCity; destTime.value = b.destTime; link.value = b.link;
    document.getElementById('routes').innerHTML = ""; 
    (b.route || []).forEach(r => addRouteUI(r.city, r.time, r.type));
    document.getElementById('delBtn').classList.remove('hidden');
    document.getElementById('adminPanel').scrollIntoView({behavior: 'smooth'});
};

/* --- INIT --- */
onSnapshot(collection(db, "buses"), snap => {
    data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    updateDashboard(); updateDropdowns(); renderList();
});

window.openMap = u => { document.getElementById('mapFrame').src = u; document.getElementById('mapModal').style.display = "block"; };
window.closeMap = () => { document.getElementById('mapFrame').src = ""; document.getElementById('mapModal').style.display = "none"; };
document.getElementById('search').oninput = renderList;
document.getElementById('operatorFilter').onchange = renderList;
document.getElementById('toCity').onchange = renderList;
</script>
</body>
</html>

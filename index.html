<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracking</title>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(to right,#2b1a00,#000);
  color:#fff;
}
.container{max-width:1000px;margin:auto;padding:15px}
h2{text-align:center}

input,select,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:8px;
  border:none;
  font-size:16px;
}
button{cursor:pointer;font-weight:bold}

.card{
  background:#111;
  padding:15px;
  border-radius:12px;
  margin:12px 0;
  box-shadow:0 0 10px #000
}
.track-btn{background:#ffd60a;color:#000}
.sort-btn{background:#023047;color:#fff}

.row{display:flex;gap:12px}
@media(max-width:700px){.row{flex-direction:column}}

.upcoming{
  background:#111;
  border-radius:14px;
  padding:15px;
  margin-bottom:12px
}
.up-title{font-size:20px;font-weight:bold;text-align:center}
.center{text-align:center;margin-top:8px}
</style>
</head>

<body>
<div class="container">

<h2>ğŸšŒ Smart Bus Tracking</h2>

<div id="upcomingDeparture" class="upcoming"></div>
<div id="upcomingArrival" class="upcoming"></div>

<input id="search" placeholder="Search city or travels">

<div class="row">
<select id="operatorSelect">
<option value="">All Operators</option>
</select>

<select id="journeyFilter">
<option value="both">Boarding & Dropping</option>
<option value="boarding">Boarding</option>
<option value="dropping">Dropping</option>
</select>
</div>

<button id="sortBtn" class="sort-btn">â° Earliest First</button>

<div id="busList"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ---------- FIREBASE ---------- */
const app = initializeApp({
 apiKey:"AIzaSyCW9wkmqETdDvGg6QraDnS6jtgmR_7lTX0",
 authDomain:"smart-bus-tracking-2ba21.firebaseapp.com",
 projectId:"smart-bus-tracking-2ba21"
});
const db = getFirestore(app);

/* ---------- STATE ---------- */
let buses=[];
let searchTxt="",operator="",journey="both",sortOrder="asc";

/* ---------- HELPERS ---------- */
function toMin(t){
 if(!t) return null;
 const p=t.trim().split(" ");
 if(p.length!==2) return null;
 let [h,m]=p[0].split(":").map(Number);
 if(isNaN(h)||isNaN(m)) return null;
 if(p[1]==="PM"&&h!==12)h+=12;
 if(p[1]==="AM"&&h===12)h=0;
 return h*60+m;
}

function nextDate(time){
 const mins=toMin(time);
 if(mins===null) return null;
 let d=new Date();
 d.setHours(Math.floor(mins/60),mins%60,0,0);
 if(d.getTime()<Date.now()) d.setDate(d.getDate()+1);
 return d;
}

function fmt(d){
 return d.toLocaleDateString()+" "+d.toLocaleTimeString();
}

/* ---------- UPCOMING ---------- */
function renderUpcoming(){
 let dep=[],arr=[];

 buses.forEach(b=>{
  if(!b.route||!b.route.length) return;

  const first=b.route[0];
  const last=b.route[b.route.length-1];

  const d1=nextDate(first.time);
  const d2=nextDate(last.time);

  if(d1) dep.push({bus:b,time:d1,city:first.city});
  if(d2) arr.push({bus:b,time:d2,city:last.city});
 });

 dep.sort((a,b)=>a.time-b.time);
 arr.sort((a,b)=>a.time-b.time);

 const depBox=document.getElementById("upcomingDeparture");
 const arrBox=document.getElementById("upcomingArrival");

 if(dep.length){
  const d=dep[0];
  depBox.innerHTML=`
   <div class="up-title">ğŸš¨ UPCOMING DEPARTURE</div>
   <div class="center">ğŸ“… ${fmt(d.time)}</div>
   <div class="center">ğŸšŒ ${d.bus.travel}</div>
   <div class="center">ğŸ“ ${d.city}</div>
  `;
 }else{
  depBox.innerHTML=`<div class="up-title">ğŸš¨ UPCOMING DEPARTURE</div>`;
 }

 if(arr.length){
  const a=arr[0];
  arrBox.innerHTML=`
   <div class="up-title">ğŸš UPCOMING ARRIVAL</div>
   <div class="center">ğŸ“… ${fmt(a.time)}</div>
   <div class="center">ğŸšŒ ${a.bus.travel}</div>
   <div class="center">ğŸ ${a.city}</div>
  `;
 }else{
  arrBox.innerHTML=`<div class="up-title">ğŸš UPCOMING ARRIVAL</div>`;
 }
}

/* ---------- LIST ---------- */
function renderList(){
 const list=document.getElementById("busList");
 list.innerHTML="";

 let filtered=buses.filter(b=>{
  if(operator && b.travel!==operator) return false;
  if(!searchTxt) return true;
  if(b.travel.toLowerCase().includes(searchTxt)) return true;
  return b.route?.some(r=>r.city?.toLowerCase().includes(searchTxt));
 });

 filtered.forEach(b=>{
  const c=document.createElement("div");
  c.className="card";
  c.innerHTML=`
   <b>ğŸšŒ ${b.travel}</b><br>
   ${b.route.map(r=>`â¡ ${r.city} ${r.time}`).join("<br>")}
   <br><br>
   <button class="track-btn" onclick="location.href='${b.link}'">Track</button>
  `;
  list.appendChild(c);
 });

 if(!filtered.length){
  list.innerHTML="<div class='card'>âŒ No buses found</div>";
 }
}

/* ---------- EVENTS ---------- */
search.oninput=e=>{searchTxt=e.target.value.toLowerCase();renderAll()};
operatorSelect.onchange=e=>{operator=e.target.value;renderAll()};
journeyFilter.onchange=e=>{journey=e.target.value;renderAll()};
sortBtn.onclick=()=>{
 sortOrder=sortOrder==="asc"?"desc":"asc";
 renderList();
};

/* ---------- OPERATORS ---------- */
function renderOperators(){
 operatorSelect.innerHTML='<option value="">All Operators</option>';
 [...new Set(buses.map(b=>b.travel))].forEach(o=>{
  const op=document.createElement("option");
  op.value=o;op.textContent=o;
  operatorSelect.appendChild(op);
 });
}

function renderAll(){
 renderUpcoming();
 renderList();
}

/* ---------- FIRESTORE ---------- */
onSnapshot(collection(db,"buses"),snap=>{
 buses=[];
 ensuresnap:
 snap.forEach(d=>{
  const x=d.data();
  if(x&&x.route&&x.travel) buses.push(x);
 });
 renderOperators();
 renderAll();
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracking</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: linear-gradient(to right, #fff3b0, #ffd60a);
}

.container {
    max-width: 900px;
    margin: auto;
    padding: 15px;
}

h2, h3 {
    text-align: center;
    color: #3a2f00;
}

input, button {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border-radius: 8px;
    border: none;
    font-size: 16px;
}

button {
    font-weight: bold;
    cursor: pointer;
}

.track-btn { background: #2a9d8f; color: white; }
.admin-btn { background: #fb8500; color: white; }
.delete-btn { background: #d00000; color: white; }
.sort-btn { background: #023047; color: white; }

.card {
    background: #fff8dc;
    padding: 15px;
    border-radius: 10px;
    margin: 12px 0;
    box-shadow: 0 0 8px rgba(0,0,0,0.2);
}

.hidden { display: none; }

/* Modal */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    z-index: 999;
}

.modal-content {
    width: 100%;
    height: 100%;
    background: white;
    display: flex;
    flex-direction: column;
}

.modal-close {
    background: #d00000;
    color: white;
    padding: 14px;
    font-size: 16px;
    border: none;
}

iframe {
    width: 100%;
    height: 100%;
    border: none;
}
</style>
</head>

<body>

<div class="container">

<h2>üöå Smart Bus Tracking</h2>

<input type="text" id="search" placeholder="Search city (Udankudi / Thoothukudi...)"
onkeyup="activeSearch=this.value.toLowerCase(); render()">

<button class="sort-btn" id="sortBtn" onclick="toggleSort()">‚è∞ Earliest First</button>

<div id="busList"></div>

<hr>

<h3>üîê Admin Login</h3>

<div id="loginBox">
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
</div>

<div id="adminPanel" class="hidden">
    <h3>Admin Panel</h3>

    <input id="travel" placeholder="Travels Name">
    <input id="routeTime" placeholder="City-Time (comma separated)">
    <small>
        Example:<br>
        Udankudi-05:30 PM, Thiruchendur-06:15 PM, Thoothukudi-07:00 PM, Madurai-11:30 PM, Chennai-07:00 AM
    </small>

    <input id="link" placeholder="Tracking Link">

    <button onclick="saveBus()">Save</button>
    <button onclick="logout()">Logout</button>
</div>

</div>

<!-- Tracking Modal -->
<div class="modal" id="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeTrack()">‚úñ Close Tracking</button>
        <iframe id="frame"></iframe>
    </div>
</div>

<script>
const ADMIN_USER = "admin";
if (!localStorage.getItem("adminPass")) {
    localStorage.setItem("adminPass", "1234");
}

let data = JSON.parse(localStorage.getItem("busData")) || [
    {
        travel: "TMV Travels",
        routeTime: "Udankudi-05:30 PM, Thiruchendur-06:15 PM, Thoothukudi-07:00 PM, Madurai-11:30 PM, Chennai-07:00 AM",
        link: "https://reports.yourbus.in/trackbus/TMVCHENNAI-TRIVANDRUM-0335PM"
    }
];

let isAdmin = false;
let editIndex = -1;
let sortOrder = "asc";
let activeSearch = "";

/* Time helpers */
function timeToMinutes(t) {
    if (!t) return 99999;
    let [time, mod] = t.split(" ");
    let [h, m] = time.split(":").map(Number);
    if (mod === "PM" && h !== 12) h += 12;
    if (mod === "AM" && h === 12) h = 0;
    return h * 60 + m;
}

/* Core logic: get correct time for searched city */
function getTimeForCity(bus, city) {
    if (!city || !bus.routeTime) return "";
    city = city.toLowerCase();

    let routes = bus.routeTime.split(",");
    for (let r of routes) {
        let [c, t] = r.split("-");
        if (!c || !t) continue;
        if (c.trim().toLowerCase().includes(city)) {
            return t.trim();
        }
    }
    return "";
}

function render() {
    const list = document.getElementById("busList");
    list.innerHTML = "";

    let filtered = data.filter(bus =>
        !activeSearch || bus.routeTime.toLowerCase().includes(activeSearch)
    );

    filtered.sort((a, b) => {
        let ta = timeToMinutes(getTimeForCity(a, activeSearch));
        let tb = timeToMinutes(getTimeForCity(b, activeSearch));
        return sortOrder === "asc" ? ta - tb : tb - ta;
    });

    filtered.forEach(bus => {
        let time = getTimeForCity(bus, activeSearch);

        let card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
            <h3>üöå ${bus.travel}</h3>
            <b>‚è∞ ${time}</b><br><br>
            üõ£Ô∏è <i>${bus.routeTime}</i><br><br>
            <button class="track-btn" onclick="openTrack('${bus.link}')">Track</button>
            ${isAdmin ? `
                <button class="admin-btn" onclick="editBus(${data.indexOf(bus)})">Edit</button>
                <button class="delete-btn" onclick="deleteBus(${data.indexOf(bus)})">Delete</button>
            ` : ""}
        `;
        list.appendChild(card);
    });
}

function toggleSort() {
    sortOrder = sortOrder === "asc" ? "desc" : "asc";
    document.getElementById("sortBtn").innerText =
        sortOrder === "asc" ? "‚è∞ Earliest First" : "‚è∞ Latest First";
    render();
}

/* Admin functions */
function login() {
    if (username.value === ADMIN_USER &&
        password.value === localStorage.getItem("adminPass")) {
        isAdmin = true;
        loginBox.classList.add("hidden");
        adminPanel.classList.remove("hidden");
        render();
    } else alert("Invalid login");
}

function logout() {
    isAdmin = false;
    adminPanel.classList.add("hidden");
    loginBox.classList.remove("hidden");
    render();
}

function saveBus() {
    let bus = {
        travel: travel.value,
        routeTime: routeTime.value,
        link: link.value
    };

    editIndex >= 0 ? data[editIndex] = bus : data.push(bus);
    editIndex = -1;

    localStorage.setItem("busData", JSON.stringify(data));
    render();
    alert("Saved");
}

function editBus(i) {
    let b = data[i];
    travel.value = b.travel;
    routeTime.value = b.routeTime;
    link.value = b.link;
    editIndex = i;
}

function deleteBus(i) {
    if (confirm("Delete bus?")) {
        data.splice(i, 1);
        localStorage.setItem("busData", JSON.stringify(data));
        render();
    }
}

/* Tracking */
function openTrack(link) {
    if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
        window.location.href = link;
    } else {
        frame.src = link;
        modal.style.display = "block";
    }
}

function closeTrack() {
    modal.style.display = "none";
    frame.src = "";
}

render();
</script>

</body>
</html>
